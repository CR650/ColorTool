<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ColorInfoæ‰€æœ‰å­—æ®µå¤„ç†ä¿®å¤æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #555;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .field-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }
        .field-column {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }
        .field-column h5 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .field-item {
            margin: 5px 0;
            padding: 5px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .field-name {
            font-weight: bold;
            color: #007bff;
        }
        .field-value {
            color: #28a745;
        }
        .field-error {
            color: #dc3545;
            background-color: #f8d7da;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>ColorInfoæ‰€æœ‰å­—æ®µå¤„ç†ä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2 class="test-title">ğŸ”§ ä¿®å¤éªŒè¯ï¼šColorInfoå·¥ä½œè¡¨æ‰€æœ‰å­—æ®µæ­£ç¡®å¤„ç†</h2>
        
        <div class="test-case">
            <h4>é—®é¢˜æè¿°</h4>
            <p>ä¿®å¤å‰ï¼šColorInfoå·¥ä½œè¡¨ä¸­çš„GuiRevealRã€EnergyHighRç­‰éUIé…ç½®å­—æ®µè¢«é”™è¯¯å¡«å…¥16è¿›åˆ¶é¢œè‰²æ•°æ®</p>
            <p>ä¿®å¤åï¼šæ‰€æœ‰å­—æ®µéƒ½åº”è¯¥ä»æ­£ç¡®çš„æ•°æ®æºï¼ˆæºæ•°æ®ColorInfoå·¥ä½œè¡¨æˆ–RSC_Theme ColorInfoå·¥ä½œè¡¨ï¼‰è·å–æ•°å€¼</p>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯1: åŒ…å«æ›´å¤šå­—æ®µçš„ColorInfoå·¥ä½œè¡¨å¤„ç†</h4>
            <p>æµ‹è¯•åŒ…å«UIé…ç½®å­—æ®µå’ŒéUIé…ç½®å­—æ®µçš„å®Œæ•´ColorInfoå·¥ä½œè¡¨å¤„ç†</p>
            <button onclick="testCompleteColorInfoProcessing()">è¿è¡Œæµ‹è¯•</button>
            <div id="test1-result" class="test-result" style="display: none;"></div>
            <div id="test1-comparison" class="field-comparison" style="display: none;">
                <div class="field-column">
                    <h5>UIé…ç½®å­—æ®µ</h5>
                    <div id="test1-ui-fields"></div>
                </div>
                <div class="field-column">
                    <h5>éUIé…ç½®å­—æ®µ</h5>
                    <div id="test1-non-ui-fields"></div>
                </div>
                <div class="field-column">
                    <h5>å¤„ç†ç»“æœ</h5>
                    <div id="test1-results"></div>
                </div>
            </div>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯2: å­—æ®µå€¼æ¥æºéªŒè¯</h4>
            <p>éªŒè¯ä¸åŒå­—æ®µä»æ­£ç¡®çš„æ•°æ®æºè·å–å€¼ï¼šæºæ•°æ®ColorInfo â†’ RSC_Theme ColorInfo â†’ é»˜è®¤å€¼</p>
            <button onclick="testFieldValueSources()">è¿è¡Œæµ‹è¯•</button>
            <div id="test2-result" class="test-result" style="display: none;"></div>
            <div id="test2-comparison" class="field-comparison" style="display: none;">
                <div class="field-column">
                    <h5>æºæ•°æ®å­—æ®µ</h5>
                    <div id="test2-source-fields"></div>
                </div>
                <div class="field-column">
                    <h5>RSC_Themeå­—æ®µ</h5>
                    <div id="test2-rsc-fields"></div>
                </div>
                <div class="field-column">
                    <h5>æœ€ç»ˆç»“æœ</h5>
                    <div id="test2-final-results"></div>
                </div>
            </div>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯3: 16è¿›åˆ¶é¢œè‰²æ•°æ®æ±¡æŸ“æ£€æµ‹</h4>
            <p>æ£€æµ‹ä¿®å¤åæ˜¯å¦è¿˜å­˜åœ¨16è¿›åˆ¶é¢œè‰²æ•°æ®è¢«é”™è¯¯å¡«å…¥æ•°å€¼å­—æ®µçš„é—®é¢˜</p>
            <button onclick="testHexColorPollution()">è¿è¡Œæµ‹è¯•</button>
            <div id="test3-result" class="test-result" style="display: none;"></div>
            <div id="test3-comparison" class="field-comparison" style="display: none;">
                <div class="field-column">
                    <h5>æ£€æµ‹åˆ°çš„16è¿›åˆ¶å€¼</h5>
                    <div id="test3-hex-values"></div>
                </div>
                <div class="field-column">
                    <h5>åº”è¯¥æ˜¯æ•°å€¼çš„å­—æ®µ</h5>
                    <div id="test3-numeric-fields"></div>
                </div>
                <div class="field-column">
                    <h5>ä¿®å¤çŠ¶æ€</h5>
                    <div id="test3-fix-status"></div>
                </div>
            </div>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯4: æ¨¡æ‹Ÿå®Œæ•´å¤„ç†æµç¨‹</h4>
            <p>æ¨¡æ‹Ÿä»addNewRowToSheetåˆ°applyColorInfoConfigToRowçš„å®Œæ•´å¤„ç†æµç¨‹</p>
            <button onclick="testCompleteProcessingFlow()">è¿è¡Œæµ‹è¯•</button>
            <div id="test4-result" class="test-result" style="display: none;"></div>
            <div id="test4-comparison" class="field-comparison" style="display: none;">
                <div class="field-column">
                    <h5>æ¨¡æ¿è¡Œæ•°æ®</h5>
                    <div id="test4-template-data"></div>
                </div>
                <div class="field-column">
                    <h5>å¤„ç†åæ•°æ®</h5>
                    <div id="test4-processed-data"></div>
                </div>
                <div class="field-column">
                    <h5>æ•°æ®å˜åŒ–</h5>
                    <div id="test4-changes"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2 class="test-title">ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log-output" class="log-output"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ§åˆ¶å°æ—¥å¿—è¾“å‡ºåˆ°é¡µé¢
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function logToPage(message, type = 'log') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR]' : type === 'warn' ? '[WARN]' : '[LOG]';
            logOutput.textContent += `${timestamp} ${prefix} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToPage(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToPage(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToPage(args.join(' '), 'error');
        };
        
        function clearLog() {
            document.getElementById('log-output').textContent = '';
        }
        
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            element.textContent = message;
        }
        
        function showComparison(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'grid';
        }
        
        function addFieldItem(containerId, fieldName, fieldValue, isError = false) {
            const container = document.getElementById(containerId);
            const item = document.createElement('div');
            item.className = `field-item ${isError ? 'field-error' : ''}`;
            item.innerHTML = `<span class="field-name">${fieldName}:</span> <span class="field-value">${fieldValue}</span>`;
            container.appendChild(item);
        }
        
        function clearFieldContainer(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
        }
        
        // åˆ›å»ºæµ‹è¯•ç”¨çš„Excelæ•°æ®
        function createTestWorkbook(sheetData) {
            const wb = XLSX.utils.book_new();
            
            Object.keys(sheetData).forEach(sheetName => {
                const ws = XLSX.utils.aoa_to_sheet(sheetData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            return wb;
        }
        
        // æ¨¡æ‹Ÿè®¾ç½®æºæ•°æ®å’Œæ˜ å°„æ¨¡å¼
        function setupTestEnvironment(mappingMode, sourceData) {
            if (typeof window.App !== 'undefined' && window.App.ThemeManager) {
                // è®¾ç½®æ˜ å°„æ¨¡å¼
                if (window.App.ThemeManager.currentMappingMode !== undefined) {
                    window.App.ThemeManager.currentMappingMode = mappingMode;
                }
                
                // è®¾ç½®æºæ•°æ®
                if (sourceData && window.App.ThemeManager.setSourceData) {
                    window.App.ThemeManager.setSourceData(sourceData);
                }
            }
        }
        
        // æµ‹è¯•å®Œæ•´ColorInfoå¤„ç†
        function testCompleteColorInfoProcessing() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯1: åŒ…å«æ›´å¤šå­—æ®µçš„ColorInfoå·¥ä½œè¡¨å¤„ç† ===');
            
            try {
                clearFieldContainer('test1-ui-fields');
                clearFieldContainer('test1-non-ui-fields');
                clearFieldContainer('test1-results');
                
                // åˆ›å»ºåŒ…å«æ›´å¤šå­—æ®µçš„ColorInfoæµ‹è¯•æ•°æ®
                const testData = {
                    'Status': [
                        ['ColorInfo'],
                        [1]  // ColorInfo=1(æœ‰æ•ˆ)
                    ],
                    'ColorInfo': [
                        // åŒ…å«UIé…ç½®å­—æ®µå’ŒéUIé…ç½®å­—æ®µ
                        ['PickupDiffR', 'PickupDiffG', 'GuiRevealR', 'EnergyHighR', 'FogStart', 'FogEnd', 'CustomField1'],
                        ['100', '150', '200', '250', '10', '50', '300']  // æºæ•°æ®å€¼
                    ]
                };
                
                const workbook = createTestWorkbook(testData);
                const sourceData = {
                    workbook: workbook,
                    fileName: 'test_complete_colorinfo.xlsx',
                    fileSize: 1024,
                    headers: ['æµ‹è¯•è¡¨å¤´'],
                    data: [{ 'æµ‹è¯•': 'æ•°æ®' }]
                };
                
                // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
                setupTestEnvironment('direct', sourceData);
                
                // æ¨¡æ‹ŸColorInfoå·¥ä½œè¡¨çš„è¡¨å¤´
                const mockHeaderRow = ['id', 'notes', 'PickupDiffR', 'PickupDiffG', 'GuiRevealR', 'EnergyHighR', 'FogStart', 'FogEnd', 'CustomField1'];
                
                // æ¨¡æ‹Ÿæ¨¡æ¿è¡Œï¼ˆåŒ…å«å¯èƒ½çš„16è¿›åˆ¶é¢œè‰²æ±¡æŸ“ï¼‰
                const mockTemplateRow = ['1', 'TemplateTheme', 'FFFFFF', 'AABBCC', 'FF0000', '00FF00', 'CCDDEE', '112233', 'ABCDEF'];
                
                // åˆ›å»ºæ–°è¡Œï¼ˆå¤åˆ¶æ¨¡æ¿è¡Œï¼‰
                const newRow = [...mockTemplateRow];
                
                console.log('æ¨¡æ¿è¡Œæ•°æ®ï¼ˆä¿®å¤å‰ï¼‰:', newRow);
                
                // æ˜¾ç¤ºUIé…ç½®å­—æ®µ
                const uiFields = ['PickupDiffR', 'PickupDiffG', 'FogStart', 'FogEnd'];
                uiFields.forEach(field => {
                    const index = mockHeaderRow.indexOf(field);
                    if (index !== -1) {
                        addFieldItem('test1-ui-fields', field, mockTemplateRow[index]);
                    }
                });
                
                // æ˜¾ç¤ºéUIé…ç½®å­—æ®µ
                const nonUIFields = ['GuiRevealR', 'EnergyHighR', 'CustomField1'];
                nonUIFields.forEach(field => {
                    const index = mockHeaderRow.indexOf(field);
                    if (index !== -1) {
                        addFieldItem('test1-non-ui-fields', field, mockTemplateRow[index], true); // æ ‡è®°ä¸ºé”™è¯¯ï¼ˆ16è¿›åˆ¶å€¼ï¼‰
                    }
                });
                
                // åº”ç”¨ä¿®å¤åçš„ColorInfoé…ç½®å¤„ç†
                if (typeof window.App !== 'undefined' && window.App.ThemeManager && 
                    typeof window.App.ThemeManager.applyColorInfoConfigToRow === 'function') {
                    
                    // è°ƒç”¨ä¿®å¤åçš„å‡½æ•°
                    window.App.ThemeManager.applyColorInfoConfigToRow(mockHeaderRow, newRow, 'TestTheme', false);
                    
                    console.log('å¤„ç†åæ•°æ®:', newRow);
                    
                    // æ£€æŸ¥å¤„ç†ç»“æœ
                    let hasHexPollution = false;
                    let processedCorrectly = 0;
                    
                    mockHeaderRow.forEach((field, index) => {
                        if (field !== 'id' && field !== 'notes') {
                            const value = newRow[index];
                            const isHexColor = /^[A-Fa-f0-9]{6}$/.test(value);
                            
                            if (isHexColor && !['PickupDiffR', 'PickupDiffG', 'PickupDiffB'].includes(field)) {
                                hasHexPollution = true;
                                addFieldItem('test1-results', field, value, true);
                            } else {
                                processedCorrectly++;
                                addFieldItem('test1-results', field, value);
                            }
                        }
                    });
                    
                    if (!hasHexPollution) {
                        showResult('test1-result', 'âœ… æµ‹è¯•é€šè¿‡ï¼šæ‰€æœ‰å­—æ®µéƒ½æ­£ç¡®å¤„ç†ï¼Œæ²¡æœ‰16è¿›åˆ¶é¢œè‰²æ±¡æŸ“', true);
                        console.log('âœ… æµ‹è¯•åœºæ™¯1é€šè¿‡ï¼šColorInfoæ‰€æœ‰å­—æ®µæ­£ç¡®å¤„ç†');
                    } else {
                        showResult('test1-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šä»å­˜åœ¨16è¿›åˆ¶é¢œè‰²æ±¡æŸ“', false);
                        console.error('âŒ æµ‹è¯•åœºæ™¯1å¤±è´¥ï¼šå­˜åœ¨16è¿›åˆ¶é¢œè‰²æ±¡æŸ“');
                    }
                    
                    showComparison('test1-comparison');
                } else {
                    showResult('test1-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šapplyColorInfoConfigToRowå‡½æ•°ä¸å¯ç”¨', false);
                }
                
            } catch (error) {
                showResult('test1-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯1å¼‚å¸¸:', error);
            }
        }
        
        // æµ‹è¯•å­—æ®µå€¼æ¥æºéªŒè¯
        function testFieldValueSources() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯2: å­—æ®µå€¼æ¥æºéªŒè¯ ===');
            
            try {
                clearFieldContainer('test2-source-fields');
                clearFieldContainer('test2-rsc-fields');
                clearFieldContainer('test2-final-results');
                
                // åˆ›å»ºæµ‹è¯•æ•°æ®ï¼šæºæ•°æ®åªæœ‰éƒ¨åˆ†å­—æ®µï¼ŒRSC_Themeæœ‰å…¶ä»–å­—æ®µ
                const testData = {
                    'Status': [
                        ['ColorInfo'],
                        [1]  // ColorInfo=1(æœ‰æ•ˆ)
                    ],
                    'ColorInfo': [
                        ['PickupDiffR', 'GuiRevealR'],  // æºæ•°æ®åªæœ‰è¿™ä¸¤ä¸ªå­—æ®µ
                        ['100', '200']
                    ]
                };
                
                const workbook = createTestWorkbook(testData);
                const sourceData = {
                    workbook: workbook,
                    fileName: 'test_field_sources.xlsx',
                    fileSize: 1024,
                    headers: ['æµ‹è¯•è¡¨å¤´'],
                    data: [{ 'æµ‹è¯•': 'æ•°æ®' }]
                };
                
                setupTestEnvironment('direct', sourceData);
                
                // æ˜¾ç¤ºæºæ•°æ®å­—æ®µ
                addFieldItem('test2-source-fields', 'PickupDiffR', '100');
                addFieldItem('test2-source-fields', 'GuiRevealR', '200');
                addFieldItem('test2-source-fields', 'EnergyHighR', '(ä¸å­˜åœ¨)');
                
                // æ¨¡æ‹ŸRSC_Themeå­—æ®µ
                addFieldItem('test2-rsc-fields', 'EnergyHighR', '300 (ä»RSC_Theme)');
                addFieldItem('test2-rsc-fields', 'CustomField', '400 (ä»RSC_Theme)');
                
                // æµ‹è¯•å­—æ®µå€¼è·å–
                if (typeof window.App !== 'undefined' && window.App.ThemeManager && 
                    typeof window.App.ThemeManager.findColorInfoValueDirect === 'function') {
                    
                    // æµ‹è¯•æºæ•°æ®å­˜åœ¨çš„å­—æ®µ
                    const sourceValue = window.App.ThemeManager.findColorInfoValueDirect('PickupDiffR', false, 'TestTheme');
                    addFieldItem('test2-final-results', 'PickupDiffR', sourceValue || 'æœªæ‰¾åˆ°');
                    
                    // æµ‹è¯•æºæ•°æ®ä¸å­˜åœ¨ä½†RSC_Themeå­˜åœ¨çš„å­—æ®µ
                    const rscValue = window.App.ThemeManager.findColorInfoValueDirect('EnergyHighR', false, 'TestTheme');
                    addFieldItem('test2-final-results', 'EnergyHighR', rscValue || 'æœªæ‰¾åˆ°');
                    
                    showResult('test2-result', 'âœ… æµ‹è¯•å®Œæˆï¼šå­—æ®µå€¼æ¥æºéªŒè¯', true);
                    showComparison('test2-comparison');
                } else {
                    showResult('test2-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šfindColorInfoValueDirectå‡½æ•°ä¸å¯ç”¨', false);
                }
                
            } catch (error) {
                showResult('test2-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯2å¼‚å¸¸:', error);
            }
        }
        
        // æµ‹è¯•16è¿›åˆ¶é¢œè‰²æ±¡æŸ“æ£€æµ‹
        function testHexColorPollution() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯3: 16è¿›åˆ¶é¢œè‰²æ•°æ®æ±¡æŸ“æ£€æµ‹ ===');
            
            try {
                clearFieldContainer('test3-hex-values');
                clearFieldContainer('test3-numeric-fields');
                clearFieldContainer('test3-fix-status');
                
                // æ¨¡æ‹ŸåŒ…å«16è¿›åˆ¶æ±¡æŸ“çš„æ¨¡æ¿è¡Œ
                const mockHeaderRow = ['id', 'notes', 'PickupDiffR', 'GuiRevealR', 'EnergyHighR', 'FogStart', 'CustomNumericField'];
                const pollutedRow = ['1', 'TestTheme', 'FFFFFF', 'AABBCC', 'FF0000', 'CCDDEE', '123ABC'];
                
                console.log('æ±¡æŸ“çš„æ¨¡æ¿è¡Œ:', pollutedRow);
                
                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„16è¿›åˆ¶å€¼
                mockHeaderRow.forEach((field, index) => {
                    if (field !== 'id' && field !== 'notes') {
                        const value = pollutedRow[index];
                        const isHexColor = /^[A-Fa-f0-9]{6}$/.test(value);
                        
                        if (isHexColor) {
                            addFieldItem('test3-hex-values', field, value, true);
                        }
                    }
                });
                
                // æ˜¾ç¤ºåº”è¯¥æ˜¯æ•°å€¼çš„å­—æ®µ
                const numericFields = ['GuiRevealR', 'EnergyHighR', 'FogStart', 'CustomNumericField'];
                numericFields.forEach(field => {
                    addFieldItem('test3-numeric-fields', field, 'åº”è¯¥æ˜¯æ•°å€¼');
                });
                
                // åº”ç”¨ä¿®å¤
                const fixedRow = [...pollutedRow];
                
                // æ¨¡æ‹Ÿä¿®å¤è¿‡ç¨‹ï¼ˆè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                setupTestEnvironment('direct', {
                    workbook: createTestWorkbook({
                        'Status': [['ColorInfo'], [1]],
                        'ColorInfo': [['PickupDiffR'], ['100']]
                    }),
                    fileName: 'test.xlsx'
                });
                
                if (typeof window.App !== 'undefined' && window.App.ThemeManager && 
                    typeof window.App.ThemeManager.applyColorInfoConfigToRow === 'function') {
                    
                    window.App.ThemeManager.applyColorInfoConfigToRow(mockHeaderRow, fixedRow, 'TestTheme', false);
                    
                    console.log('ä¿®å¤åçš„è¡Œ:', fixedRow);
                    
                    // æ£€æŸ¥ä¿®å¤çŠ¶æ€
                    let fixedCount = 0;
                    let stillPolluted = 0;
                    
                    mockHeaderRow.forEach((field, index) => {
                        if (field !== 'id' && field !== 'notes') {
                            const originalValue = pollutedRow[index];
                            const fixedValue = fixedRow[index];
                            const wasHex = /^[A-Fa-f0-9]{6}$/.test(originalValue);
                            const stillHex = /^[A-Fa-f0-9]{6}$/.test(fixedValue);
                            
                            if (wasHex && !stillHex) {
                                fixedCount++;
                                addFieldItem('test3-fix-status', field, `âœ… å·²ä¿®å¤: ${originalValue} â†’ ${fixedValue}`);
                            } else if (wasHex && stillHex) {
                                stillPolluted++;
                                addFieldItem('test3-fix-status', field, `âŒ ä»æ±¡æŸ“: ${fixedValue}`, true);
                            } else {
                                addFieldItem('test3-fix-status', field, `âœ… æ­£å¸¸: ${fixedValue}`);
                            }
                        }
                    });
                    
                    if (stillPolluted === 0) {
                        showResult('test3-result', `âœ… æµ‹è¯•é€šè¿‡ï¼šä¿®å¤äº†${fixedCount}ä¸ªå­—æ®µï¼Œæ— 16è¿›åˆ¶æ±¡æŸ“`, true);
                    } else {
                        showResult('test3-result', `âŒ æµ‹è¯•å¤±è´¥ï¼šä»æœ‰${stillPolluted}ä¸ªå­—æ®µå­˜åœ¨16è¿›åˆ¶æ±¡æŸ“`, false);
                    }
                    
                    showComparison('test3-comparison');
                } else {
                    showResult('test3-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šapplyColorInfoConfigToRowå‡½æ•°ä¸å¯ç”¨', false);
                }
                
            } catch (error) {
                showResult('test3-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯3å¼‚å¸¸:', error);
            }
        }
        
        // æµ‹è¯•å®Œæ•´å¤„ç†æµç¨‹
        function testCompleteProcessingFlow() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯4: æ¨¡æ‹Ÿå®Œæ•´å¤„ç†æµç¨‹ ===');
            
            try {
                clearFieldContainer('test4-template-data');
                clearFieldContainer('test4-processed-data');
                clearFieldContainer('test4-changes');
                
                // æ¨¡æ‹Ÿå®Œæ•´çš„å¤„ç†æµç¨‹
                const headerRow = ['id', 'notes', 'PickupDiffR', 'PickupDiffG', 'GuiRevealR', 'EnergyHighR', 'FogStart'];
                const templateRow = ['5', 'LastTheme', 'FFFFFF', 'AABBCC', 'FF0000', '00FF00', 'CCDDEE'];
                const newRow = [...templateRow]; // å¤åˆ¶æ¨¡æ¿è¡Œ
                
                // æ˜¾ç¤ºæ¨¡æ¿è¡Œæ•°æ®
                headerRow.forEach((field, index) => {
                    addFieldItem('test4-template-data', field, templateRow[index]);
                });
                
                // è®¾ç½®æµ‹è¯•ç¯å¢ƒ
                setupTestEnvironment('direct', {
                    workbook: createTestWorkbook({
                        'Status': [['ColorInfo'], [1]],
                        'ColorInfo': [
                            ['PickupDiffR', 'PickupDiffG', 'GuiRevealR'],
                            ['100', '150', '200']
                        ]
                    }),
                    fileName: 'test_flow.xlsx'
                });
                
                // æ¨¡æ‹ŸaddNewRowToSheetçš„å¤„ç†
                console.log('æ¨¡æ‹ŸaddNewRowToSheetå¤„ç†...');
                
                // 1. è®¾ç½®IDï¼ˆè‡ªåŠ¨é€’å¢ï¼‰
                newRow[0] = '6';
                
                // 2. è®¾ç½®notesï¼ˆä¸»é¢˜åç§°ï¼‰
                newRow[1] = 'NewTestTheme';
                
                // 3. åº”ç”¨ColorInfoé…ç½®
                if (typeof window.App !== 'undefined' && window.App.ThemeManager && 
                    typeof window.App.ThemeManager.applyColorInfoConfigToRow === 'function') {
                    
                    window.App.ThemeManager.applyColorInfoConfigToRow(headerRow, newRow, 'NewTestTheme', true);
                    
                    // æ˜¾ç¤ºå¤„ç†åæ•°æ®
                    headerRow.forEach((field, index) => {
                        addFieldItem('test4-processed-data', field, newRow[index]);
                    });
                    
                    // æ˜¾ç¤ºæ•°æ®å˜åŒ–
                    headerRow.forEach((field, index) => {
                        const oldValue = templateRow[index];
                        const newValue = newRow[index];
                        
                        if (oldValue !== newValue) {
                            addFieldItem('test4-changes', field, `${oldValue} â†’ ${newValue}`);
                        } else {
                            addFieldItem('test4-changes', field, 'æ— å˜åŒ–');
                        }
                    });
                    
                    showResult('test4-result', 'âœ… æµ‹è¯•å®Œæˆï¼šå®Œæ•´å¤„ç†æµç¨‹æ¨¡æ‹ŸæˆåŠŸ', true);
                    showComparison('test4-comparison');
                    
                    console.log('âœ… æµ‹è¯•åœºæ™¯4å®Œæˆï¼šå®Œæ•´å¤„ç†æµç¨‹éªŒè¯');
                } else {
                    showResult('test4-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šapplyColorInfoConfigToRowå‡½æ•°ä¸å¯ç”¨', false);
                }
                
            } catch (error) {
                showResult('test4-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯4å¼‚å¸¸:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ColorInfoæ‰€æœ‰å­—æ®µå¤„ç†ä¿®å¤æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('XLSXåº“ç‰ˆæœ¬:', typeof XLSX !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            console.log('ThemeManageræ¨¡å—:', typeof window.App !== 'undefined' && window.App.ThemeManager ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            
            if (typeof window.App !== 'undefined' && window.App.ThemeManager) {
                console.log('å¯ç”¨çš„ColorInfoå‡½æ•°:');
                console.log('- applyColorInfoConfigToRow:', typeof window.App.ThemeManager.applyColorInfoConfigToRow);
                console.log('- findColorInfoValueDirect:', typeof window.App.ThemeManager.findColorInfoValueDirect);
                console.log('- findColorInfoValueFromSourceColorInfo:', typeof window.App.ThemeManager.findColorInfoValueFromSourceColorInfo);
                console.log('- findColorInfoValueFromRSCThemeColorInfo:', typeof window.App.ThemeManager.findColorInfoValueFromRSCThemeColorInfo);
            }
        });
    </script>
    
    <!-- å¼•å…¥ä¿®æ”¹åçš„themeManager.jsè¿›è¡Œæµ‹è¯• -->
    <script src="js/utils.js"></script>
    <script src="js/themeManager.js"></script>
</body>
</html>
