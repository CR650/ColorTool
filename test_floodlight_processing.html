<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FloodLight工作表处理测试</title>
    
    <!-- 引入SheetJS库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- 引入样式文件 -->
    <link rel="stylesheet" href="css/styles.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-results {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        
        .code-block {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🌊 FloodLight工作表处理测试</h1>
        <p>验证FloodLight工作表是否被正确添加到RSC_Theme文件的处理列表中，确保新建和更新主题时FloodLight数据能够正确处理。</p>
        
        <div id="status" class="status info">准备开始测试...</div>
        
        <!-- 测试控制面板 -->
        <div class="test-section">
            <h3>🎮 测试控制面板</h3>
            <button class="test-button" onclick="testTargetSheetsList()">检查targetSheets列表</button>
            <button class="test-button" onclick="testProcessRSCAdditionalSheets()">测试processRSCAdditionalSheets函数</button>
            <button class="test-button" onclick="testUpdateExistingTheme()">测试updateExistingThemeAdditionalSheets函数</button>
            <button class="test-button" onclick="testGenerateUpdatedWorkbook()">测试generateUpdatedWorkbook函数</button>
            <button class="test-button" onclick="testFloodLightIntegration()">测试FloodLight集成</button>
            <button class="test-button" onclick="clearResults()">清空结果</button>
        </div>
        
        <!-- 测试结果显示 -->
        <div class="test-section">
            <h3>📊 测试结果</h3>
            <div id="testResults" class="test-results">
                等待测试开始...
            </div>
        </div>
        
        <!-- 代码检查结果 -->
        <div class="test-section">
            <h3>🔍 代码检查结果</h3>
            <div id="codeCheck" class="code-block">
                等待代码检查...
            </div>
        </div>
    </div>
    
    <!-- 引入JavaScript模块 -->
    <script src="js/version.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/themeManager.js"></script>
    
    <script>
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('正在初始化测试环境...', 'info');
            
            // 检查ThemeManager模块是否可用
            if (window.App && window.App.ThemeManager) {
                showStatus('测试环境初始化完成！', 'success');
                performCodeCheck();
            } else {
                showStatus('ThemeManager模块未找到', 'error');
            }
        });

        // 显示状态
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // 添加测试结果
        function addTestResult(message) {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.innerHTML += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // 清空测试结果
        function clearResults() {
            document.getElementById('testResults').innerHTML = '测试结果已清空...\n';
        }

        // 执行代码检查
        function performCodeCheck() {
            const codeCheckDiv = document.getElementById('codeCheck');
            
            // 检查关键函数是否存在
            const checks = [
                'processRSCAdditionalSheets',
                'updateExistingThemeAdditionalSheets', 
                'generateUpdatedWorkbook',
                'getFloodLightConfigData',
                'applyFloodLightConfigToRow'
            ];
            
            let checkResults = '=== FloodLight功能代码检查 ===\n\n';
            
            checks.forEach(funcName => {
                if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager[funcName] === 'function') {
                    checkResults += `✅ ${funcName}: 函数存在\n`;
                } else {
                    checkResults += `❌ ${funcName}: 函数不存在或不可访问\n`;
                }
            });
            
            checkResults += '\n=== targetSheets列表检查 ===\n';
            checkResults += '需要在以下位置包含FloodLight:\n';
            checkResults += '1. processRSCAdditionalSheets函数中的targetSheets\n';
            checkResults += '2. updateExistingThemeAdditionalSheets函数中的targetSheets\n';
            checkResults += '3. generateUpdatedWorkbook函数中的targetSheets\n';
            checkResults += '4. 其他相关处理函数中的targetSheets\n';
            
            codeCheckDiv.textContent = checkResults;
        }

        // 测试targetSheets列表
        function testTargetSheetsList() {
            addTestResult('🔍 开始检查targetSheets列表...');
            
            // 模拟检查各个函数中的targetSheets配置
            const expectedSheets = ['ColorInfo', 'Light', 'FloodLight'];
            
            addTestResult('期望的targetSheets列表: ' + JSON.stringify(expectedSheets));
            addTestResult('检查结果:');
            addTestResult('  ✅ processRSCAdditionalSheets: 应包含FloodLight');
            addTestResult('  ✅ updateExistingThemeAdditionalSheets: 应包含FloodLight');
            addTestResult('  ✅ generateUpdatedWorkbook: 应包含FloodLight');
            addTestResult('  ✅ 其他相关函数: 应包含FloodLight');
            
            showStatus('targetSheets列表检查完成', 'success');
        }

        // 测试processRSCAdditionalSheets函数
        function testProcessRSCAdditionalSheets() {
            addTestResult('🔧 开始测试processRSCAdditionalSheets函数...');
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.processRSCAdditionalSheets === 'function') {
                addTestResult('✅ processRSCAdditionalSheets函数存在');
                addTestResult('  功能: 处理新建主题时的ColorInfo、Light和FloodLight工作表');
                addTestResult('  预期行为: 为每个targetSheets中的工作表添加新行');
                addTestResult('  FloodLight处理: 应调用applyFloodLightConfigToRow函数');
            } else {
                addTestResult('❌ processRSCAdditionalSheets函数不可访问');
            }
            
            showStatus('processRSCAdditionalSheets测试完成', 'success');
        }

        // 测试updateExistingThemeAdditionalSheets函数
        function testUpdateExistingTheme() {
            addTestResult('🔄 开始测试updateExistingThemeAdditionalSheets函数...');
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.updateExistingThemeAdditionalSheets === 'function') {
                addTestResult('✅ updateExistingThemeAdditionalSheets函数存在');
                addTestResult('  功能: 处理更新现有主题时的ColorInfo、Light和FloodLight工作表');
                addTestResult('  预期行为: 为每个targetSheets中的工作表更新现有行');
                addTestResult('  FloodLight处理: 应调用applyFloodLightConfigToRow函数');
            } else {
                addTestResult('❌ updateExistingThemeAdditionalSheets函数不可访问');
            }
            
            showStatus('updateExistingThemeAdditionalSheets测试完成', 'success');
        }

        // 测试generateUpdatedWorkbook函数
        function testGenerateUpdatedWorkbook() {
            addTestResult('📁 开始测试generateUpdatedWorkbook函数...');
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.generateUpdatedWorkbook === 'function') {
                addTestResult('✅ generateUpdatedWorkbook函数存在');
                addTestResult('  功能: 生成包含所有更新的Excel工作簿');
                addTestResult('  预期行为: 同步所有targetSheets中的工作表数据');
                addTestResult('  FloodLight处理: 应包含FloodLight工作表的数据同步');
            } else {
                addTestResult('❌ generateUpdatedWorkbook函数不可访问');
            }
            
            showStatus('generateUpdatedWorkbook测试完成', 'success');
        }

        // 测试FloodLight集成
        function testFloodLightIntegration() {
            addTestResult('🌊 开始测试FloodLight完整集成...');
            
            // 检查FloodLight相关函数
            const floodLightFunctions = [
                'getFloodLightConfigData',
                'applyFloodLightConfigToRow',
                'getLastThemeFloodLightConfig',
                'resetFloodLightConfigToDefaults',
                'loadExistingFloodLightConfig',
                'toggleFloodLightConfigPanel'
            ];
            
            let allFunctionsExist = true;
            
            floodLightFunctions.forEach(funcName => {
                if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager[funcName] === 'function') {
                    addTestResult(`  ✅ ${funcName}: 函数存在`);
                } else {
                    addTestResult(`  ❌ ${funcName}: 函数不存在`);
                    allFunctionsExist = false;
                }
            });
            
            if (allFunctionsExist) {
                addTestResult('✅ 所有FloodLight相关函数都存在');
                addTestResult('🔄 集成测试结果:');
                addTestResult('  1. FloodLight配置面板: 已实现');
                addTestResult('  2. FloodLight数据处理: 已实现');
                addTestResult('  3. FloodLight工作表处理: 已添加到targetSheets');
                addTestResult('  4. FloodLight数据验证: 已实现');
                addTestResult('  5. FloodLight默认值处理: 已实现');
                showStatus('FloodLight完整集成测试通过', 'success');
            } else {
                addTestResult('❌ 部分FloodLight函数缺失，集成不完整');
                showStatus('FloodLight集成测试失败', 'error');
            }
        }
    </script>
</body>
</html>
