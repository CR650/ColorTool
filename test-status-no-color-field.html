<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statuså·¥ä½œè¡¨æ— Colorå­—æ®µæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .log { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            max-height: 400px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Statuså·¥ä½œè¡¨æ— Colorå­—æ®µæµ‹è¯•</h1>
    <p>æµ‹è¯•å½“Statuså·¥ä½œè¡¨ä¸­æ²¡æœ‰Colorå­—æ®µæ—¶ï¼Œæ›´æ–°ç°æœ‰ä¸»é¢˜æ˜¯å¦èƒ½æ­£ç¡®ä»RSC_Themeæ–‡ä»¶è¯»å–é¢œè‰²å€¼</p>
    
    <div>
        <button onclick="testNoColorFieldUpdateExisting()">æµ‹è¯•ï¼šæ— Colorå­—æ®µ + æ›´æ–°ç°æœ‰ä¸»é¢˜</button>
        <button onclick="testNoColorFieldNewTheme()">æµ‹è¯•ï¼šæ— Colorå­—æ®µ + æ–°å»ºä¸»é¢˜</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div id="results"></div>
    <div id="log" class="log"></div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
        }
        
        function showResult(message, isSuccess) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }

        // æ¨¡æ‹ŸparseStatusSheetå‡½æ•°ï¼ˆè¿”å›æ— Colorå­—æ®µçš„çŠ¶æ€ï¼‰
        function parseStatusSheet(sourceData) {
            log('=== å¼€å§‹è§£æStatuså·¥ä½œè¡¨ ===');

            if (!sourceData || !sourceData.workbook) {
                log('æºæ•°æ®æ— æ•ˆï¼Œæ— æ³•è§£æStatuså·¥ä½œè¡¨');
                return { colorStatus: 0, hasColorField: false, error: 'æºæ•°æ®æ— æ•ˆ' };
            }

            try {
                const statusSheet = sourceData.workbook.Sheets['Status'];
                if (!statusSheet) {
                    log('Statuså·¥ä½œè¡¨ä¸å­˜åœ¨');
                    return { colorStatus: 0, hasColorField: false, error: 'Statuså·¥ä½œè¡¨ä¸å­˜åœ¨' };
                }

                const statusData = XLSX.utils.sheet_to_json(statusSheet, {
                    header: 1,
                    defval: '',
                    raw: false
                });

                if (!statusData || statusData.length < 2) {
                    log('Statuså·¥ä½œè¡¨æ•°æ®ä¸è¶³');
                    return { colorStatus: 0, hasColorField: false, error: 'Statuså·¥ä½œè¡¨æ•°æ®ä¸è¶³' };
                }

                const headers = statusData[0];
                const statusRow = statusData[1];

                log('Statuså·¥ä½œè¡¨è¡¨å¤´: ' + headers.join(', '));
                log('Statuså·¥ä½œè¡¨çŠ¶æ€è¡Œ: ' + statusRow.join(', '));

                // æŸ¥æ‰¾Coloråˆ—çš„ç´¢å¼•
                const colorColumnIndex = headers.findIndex(header => {
                    if (!header) return false;
                    const headerStr = header.toString().trim().toUpperCase();
                    return headerStr === 'COLOR';
                });

                if (colorColumnIndex === -1) {
                    log('Statuså·¥ä½œè¡¨ä¸­æœªæ‰¾åˆ°Coloråˆ—');
                    return { colorStatus: 0, hasColorField: false, error: 'æœªæ‰¾åˆ°Coloråˆ—' };
                }

                const colorStatusValue = statusRow[colorColumnIndex];
                const colorStatus = parseInt(colorStatusValue) || 0;

                log(`Colorå­—æ®µçŠ¶æ€: ${colorStatus} (åŸå§‹å€¼: "${colorStatusValue}")`);

                const result = {
                    colorStatus: colorStatus,
                    hasColorField: true,
                    colorColumnIndex: colorColumnIndex,
                    headers: headers,
                    statusRow: statusRow,
                    isColorValid: colorStatus === 1
                };

                log('Statuså·¥ä½œè¡¨è§£æç»“æœ: ' + JSON.stringify(result, null, 2));
                return result;

            } catch (error) {
                log('è§£æStatuså·¥ä½œè¡¨æ—¶å‡ºé”™: ' + error.message);
                return { colorStatus: 0, hasColorField: false, error: error.message };
            }
        }

        // æ¨¡æ‹ŸfindColorValueFromRSCThemeå‡½æ•°
        function findColorValueFromRSCTheme(colorChannel, themeName) {
            log(`=== ä»RSC_Themeæ–‡ä»¶æŸ¥æ‰¾é¢œè‰²å€¼: ${colorChannel} ===`);
            log(`ä¸»é¢˜åç§°: ${themeName}`);

            // æ¨¡æ‹ŸRSC_Themeæ–‡ä»¶ä¸­æœ‰è¯¥ä¸»é¢˜çš„é¢œè‰²æ•°æ®
            const mockRSCColors = {
                'TestTheme': {
                    'P1': 'FF0000',
                    'P2': '00FF00',
                    'G1': '0000FF'
                }
            };

            if (mockRSCColors[themeName] && mockRSCColors[themeName][colorChannel]) {
                const colorValue = mockRSCColors[themeName][colorChannel];
                log(`âœ… ä»RSC_Themeæ‰¾åˆ° ${colorChannel} = ${colorValue} (ä¸»é¢˜: ${themeName})`);
                return colorValue;
            }

            log(`RSC_Themeä¸­æœªæ‰¾åˆ°ä¸»é¢˜ ${themeName} çš„ ${colorChannel} é¢œè‰²å€¼`);
            return null;
        }

        // ä¿®å¤åçš„findColorValueDirectå‡½æ•°
        function findColorValueDirect(colorChannel, isNewTheme = false, themeName = '') {
            log(`=== ç›´æ¥æ˜ å°„æŸ¥æ‰¾é¢œè‰²å€¼: ${colorChannel} (æ–°ä¸»é¢˜: ${isNewTheme}, ä¸»é¢˜å: ${themeName}) ===`);

            // æ¨¡æ‹Ÿæºæ•°æ®
            const sourceData = {
                workbook: {
                    Sheets: {
                        'Status': {
                            // æ¨¡æ‹ŸStatuså·¥ä½œè¡¨æ•°æ®
                        }
                    }
                }
            };

            // è§£æStatuså·¥ä½œè¡¨çŠ¶æ€
            const statusInfo = parseStatusSheet(sourceData);
            log('StatusçŠ¶æ€ä¿¡æ¯: ' + JSON.stringify(statusInfo));

            if (!statusInfo.hasColorField) {
                log('Statuså·¥ä½œè¡¨ä¸­æ²¡æœ‰Colorå­—æ®µï¼Œæ ¹æ®ä¸»é¢˜ç±»å‹å¤„ç†');
                
                if (!isNewTheme && themeName) {
                    // æ›´æ–°ç°æœ‰ä¸»é¢˜æ¨¡å¼ï¼šç›´æ¥ä»RSC_Themeæ–‡ä»¶è¯»å–
                    log('æ›´æ–°ç°æœ‰ä¸»é¢˜ä¸”æ— Colorå­—æ®µï¼Œç›´æ¥ä»RSC_Themeæ–‡ä»¶è¯»å–é¢œè‰²å€¼');
                    const rscColorValue = findColorValueFromRSCTheme(colorChannel, themeName);
                    if (rscColorValue) {
                        log(`âœ… ä»RSC_Themeæ–‡ä»¶æ‰¾åˆ°: ${colorChannel} = ${rscColorValue}`);
                        return rscColorValue;
                    }
                }
                
                // æ–°å»ºä¸»é¢˜æ¨¡å¼æˆ–æœªæ‰¾åˆ°ï¼šè¿”å›nullï¼Œä½¿ç”¨é»˜è®¤å€¼
                log(`âš ï¸ æ— Colorå­—æ®µï¼Œ${isNewTheme ? 'æ–°å»ºä¸»é¢˜' : 'ç°æœ‰ä¸»é¢˜'}æœªæ‰¾åˆ°é¢œè‰²å€¼: ${colorChannel}`);
                return null;
            }

            // å¦‚æœæœ‰Colorå­—æ®µï¼Œç»§ç»­åŸæœ‰é€»è¾‘...
            const isColorValid = statusInfo.isColorValid;
            log(`Colorå­—æ®µçŠ¶æ€: ${isColorValid ? 'æœ‰æ•ˆ(1)' : 'æ— æ•ˆ(0)'}`);
            
            // è¿™é‡Œçœç•¥å…¶ä»–é€»è¾‘ï¼Œä¸“æ³¨æµ‹è¯•æ— Colorå­—æ®µçš„æƒ…å†µ
            return null;
        }

        // åˆ›å»ºæµ‹è¯•å·¥ä½œç°¿ï¼ˆStatuså·¥ä½œè¡¨æ— Colorå­—æ®µï¼‰
        function createTestWorkbook() {
            const testData = {
                'Status': [
                    ['Light', 'FloodLight', 'VolumetricFog'],  // è¡¨å¤´ï¼šæ²¡æœ‰Colorå­—æ®µ
                    [1, 0, 1]                                  // çŠ¶æ€è¡Œ
                ]
            };
            
            const wb = XLSX.utils.book_new();
            Object.keys(testData).forEach(sheetName => {
                const ws = XLSX.utils.aoa_to_sheet(testData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            return wb;
        }

        // æµ‹è¯•ï¼šæ— Colorå­—æ®µ + æ›´æ–°ç°æœ‰ä¸»é¢˜
        function testNoColorFieldUpdateExisting() {
            clearLog();
            log('ğŸ§ª æµ‹è¯•ï¼šStatuså·¥ä½œè¡¨æ— Colorå­—æ®µ + æ›´æ–°ç°æœ‰ä¸»é¢˜');
            
            try {
                const workbook = createTestWorkbook();
                const sourceData = { workbook: workbook, fileName: 'test.xlsx' };
                
                // æµ‹è¯•æ›´æ–°ç°æœ‰ä¸»é¢˜ï¼ˆisNewTheme=falseï¼‰
                const colorValue = findColorValueDirect('P1', false, 'TestTheme');
                
                if (colorValue === 'FF0000') {
                    showResult('âœ… æµ‹è¯•é€šè¿‡ï¼šæ— Colorå­—æ®µæ—¶ï¼Œæ›´æ–°ç°æœ‰ä¸»é¢˜æ­£ç¡®ä»RSC_Themeè¯»å–é¢œè‰²å€¼', true);
                    log('âœ… æµ‹è¯•é€šè¿‡ï¼šè¿”å›äº†æ­£ç¡®çš„RSC_Themeé¢œè‰²å€¼');
                } else if (colorValue === null) {
                    showResult('âŒ æµ‹è¯•å¤±è´¥ï¼šåº”è¯¥ä»RSC_Themeè¯»å–é¢œè‰²å€¼ï¼Œä½†è¿”å›äº†null', false);
                    log('âŒ æµ‹è¯•å¤±è´¥ï¼šåº”è¯¥ä»RSC_Themeè¯»å–é¢œè‰²å€¼');
                } else {
                    showResult('âŒ æµ‹è¯•å¤±è´¥ï¼šè¿”å›äº†æ„å¤–çš„é¢œè‰²å€¼: ' + colorValue, false);
                    log('âŒ æµ‹è¯•å¤±è´¥ï¼šè¿”å›äº†æ„å¤–çš„é¢œè‰²å€¼');
                }
                
            } catch (error) {
                showResult('âŒ æµ‹è¯•å¼‚å¸¸: ' + error.message, false);
                log('æµ‹è¯•å¼‚å¸¸: ' + error.message);
            }
        }

        // æµ‹è¯•ï¼šæ— Colorå­—æ®µ + æ–°å»ºä¸»é¢˜
        function testNoColorFieldNewTheme() {
            clearLog();
            log('ğŸ§ª æµ‹è¯•ï¼šStatuså·¥ä½œè¡¨æ— Colorå­—æ®µ + æ–°å»ºä¸»é¢˜');
            
            try {
                const workbook = createTestWorkbook();
                const sourceData = { workbook: workbook, fileName: 'test.xlsx' };
                
                // æµ‹è¯•æ–°å»ºä¸»é¢˜ï¼ˆisNewTheme=trueï¼‰
                const colorValue = findColorValueDirect('P1', true, 'NewTheme');
                
                if (colorValue === null) {
                    showResult('âœ… æµ‹è¯•é€šè¿‡ï¼šæ— Colorå­—æ®µæ—¶ï¼Œæ–°å»ºä¸»é¢˜æ­£ç¡®è¿”å›nullï¼ˆä½¿ç”¨é»˜è®¤å€¼ï¼‰', true);
                    log('âœ… æµ‹è¯•é€šè¿‡ï¼šæ–°å»ºä¸»é¢˜æ­£ç¡®è¿”å›null');
                } else {
                    showResult('âŒ æµ‹è¯•å¤±è´¥ï¼šæ–°å»ºä¸»é¢˜åº”è¯¥è¿”å›nullï¼Œä½†è¿”å›äº†: ' + colorValue, false);
                    log('âŒ æµ‹è¯•å¤±è´¥ï¼šæ–°å»ºä¸»é¢˜åº”è¯¥è¿”å›null');
                }
                
            } catch (error) {
                showResult('âŒ æµ‹è¯•å¼‚å¸¸: ' + error.message, false);
                log('æµ‹è¯•å¼‚å¸¸: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            log('Statuså·¥ä½œè¡¨æ— Colorå­—æ®µæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('XLSXåº“: ' + (typeof XLSX !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½'));
        });
    </script>
</body>
</html>
