<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›´æ¥æ˜ å°„æ¨¡å¼æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">ğŸ¯ ç›´æ¥æ˜ å°„æ¨¡å¼åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>æµ‹è¯•è¯´æ˜</h2>
            <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•ç›´æ¥æ˜ å°„æ¨¡å¼çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p>
            <ul>
                <li>æ˜ å°„æ¨¡å¼æ£€æµ‹é€»è¾‘</li>
                <li>Colorå·¥ä½œè¡¨æ•°æ®è¯»å–</li>
                <li>ç›´æ¥å­—æ®µæ˜ å°„å¤„ç†</li>
                <li>UIæŒ‡ç¤ºå™¨æ›´æ–°</li>
            </ul>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•ç”¨ä¾‹1ï¼šæ˜ å°„æ¨¡å¼æ£€æµ‹</h2>
            <button onclick="testMappingModeDetection()">è¿è¡Œæµ‹è¯•</button>
            <div id="test1Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•ç”¨ä¾‹2ï¼šç›´æ¥æ˜ å°„å­—æ®µæŸ¥æ‰¾</h2>
            <button onclick="testDirectFieldMapping()">è¿è¡Œæµ‹è¯•</button>
            <div id="test2Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•ç”¨ä¾‹3ï¼šUIæŒ‡ç¤ºå™¨æ›´æ–°</h2>
            <button onclick="testUIIndicatorUpdate()">è¿è¡Œæµ‹è¯•</button>
            <div id="test3Result" class="test-result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ</h2>
            <button onclick="generateMockData()">ç”Ÿæˆæµ‹è¯•ç”¨Colorå·¥ä½œè¡¨æ•°æ®</button>
            <div id="mockDataResult" class="test-result" style="display: none;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // æ¨¡æ‹Ÿæµ‹è¯•æ•°æ®
        let mockSourceData = null;

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${type}`;
            element.innerHTML = message;
        }

        function testMappingModeDetection() {
            try {
                // åˆ›å»ºæ¨¡æ‹Ÿçš„æºæ•°æ®
                const mockData = {
                    workbook: {
                        SheetNames: ['Color', 'Other'],
                        Sheets: {
                            'Color': {
                                'A1': { v: 'G1' },
                                'B1': { v: 'G2' },
                                'C1': { v: 'P1' },
                                'D1': { v: 'P2' },
                                'E1': { v: 'P3' },
                                'F1': { v: 'P4' },
                                'A2': { v: 'FF0000' },
                                'B2': { v: '00FF00' },
                                'C2': { v: '0000FF' },
                                'D2': { v: 'FFFF00' },
                                'E2': { v: 'FF00FF' },
                                'F2': { v: '00FFFF' },
                                '!ref': 'A1:F2'
                            }
                        }
                    }
                };

                // æ¨¡æ‹Ÿæ£€æµ‹å‡½æ•°
                const detectResult = simulateDetectMappingMode(mockData);
                
                showResult('test1Result', 
                    `âœ… æ˜ å°„æ¨¡å¼æ£€æµ‹æµ‹è¯•é€šè¿‡<br>
                    æ£€æµ‹ç»“æœ: ${detectResult}<br>
                    é¢„æœŸç»“æœ: direct<br>
                    æµ‹è¯•çŠ¶æ€: ${detectResult === 'direct' ? 'æˆåŠŸ' : 'å¤±è´¥'}`, 
                    detectResult === 'direct' ? 'success' : 'error'
                );
            } catch (error) {
                showResult('test1Result', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateDetectMappingMode(sourceData) {
            if (!sourceData || !sourceData.workbook) {
                return 'json';
            }

            const sheetNames = sourceData.workbook.SheetNames;
            const hasColorSheet = sheetNames.includes('Color');
            if (!hasColorSheet) {
                return 'json';
            }

            try {
                const colorSheet = sourceData.workbook.Sheets['Color'];
                const colorData = XLSX.utils.sheet_to_json(colorSheet, { 
                    header: 1, 
                    defval: '',
                    raw: false 
                });

                if (!colorData || colorData.length < 2) {
                    return 'json';
                }

                const headers = colorData[0];
                const directMappingFields = [];
                for (let i = 1; i <= 7; i++) directMappingFields.push(`G${i}`);
                for (let i = 1; i <= 49; i++) directMappingFields.push(`P${i}`);

                const foundFields = headers.filter(header => 
                    directMappingFields.includes(header?.toString().trim().toUpperCase())
                );

                return foundFields.length >= 5 ? 'direct' : 'json';
            } catch (error) {
                return 'json';
            }
        }

        function testDirectFieldMapping() {
            try {
                generateMockData();
                
                // æµ‹è¯•å­—æ®µæŸ¥æ‰¾
                const testFields = ['G1', 'P1', 'P3', 'NONEXISTENT'];
                const results = [];
                
                testFields.forEach(field => {
                    const value = simulateFindColorValueDirect(field);
                    results.push(`${field}: ${value || 'null'}`);
                });
                
                showResult('test2Result', 
                    `âœ… ç›´æ¥æ˜ å°„å­—æ®µæŸ¥æ‰¾æµ‹è¯•å®Œæˆ<br>
                    <div class="code-block">${results.join('\n')}</div>`, 
                    'success'
                );
            } catch (error) {
                showResult('test2Result', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function simulateFindColorValueDirect(colorChannel) {
            if (!mockSourceData || !mockSourceData.workbook) {
                return null;
            }

            try {
                const colorSheet = mockSourceData.workbook.Sheets['Color'];
                if (!colorSheet) return null;

                const colorData = XLSX.utils.sheet_to_json(colorSheet, { 
                    header: 1, 
                    defval: '',
                    raw: false 
                });

                if (!colorData || colorData.length < 2) return null;

                const headers = colorData[0];
                const dataRow = colorData[1];

                const columnIndex = headers.findIndex(header => 
                    header?.toString().trim().toUpperCase() === colorChannel.toUpperCase()
                );

                if (columnIndex === -1) return null;

                const colorValue = dataRow[columnIndex];
                if (!colorValue || colorValue === '') return null;

                let cleanValue = colorValue.toString().trim().toUpperCase();
                if (cleanValue.startsWith('#')) {
                    cleanValue = cleanValue.substring(1);
                }

                return cleanValue;
            } catch (error) {
                return null;
            }
        }

        function testUIIndicatorUpdate() {
            // æ¨¡æ‹ŸUIæ›´æ–°æµ‹è¯•
            showResult('test3Result', 
                `âœ… UIæŒ‡ç¤ºå™¨æ›´æ–°æµ‹è¯•<br>
                æ˜ å°„æ¨¡å¼æŒ‡ç¤ºå™¨åŠŸèƒ½éœ€è¦åœ¨ä¸»åº”ç”¨ä¸­æµ‹è¯•<br>
                æµ‹è¯•é¡¹ç›®ï¼š<br>
                - æºæ•°æ®æ–‡ä»¶é€‰æ‹©ç»“æœä¸­çš„æ˜ å°„æ¨¡å¼ä¿¡æ¯<br>
                - ç‹¬ç«‹æ˜ å°„æ¨¡å¼æŒ‡ç¤ºå™¨çš„æ˜¾ç¤ºå’Œæ ·å¼<br>
                - æ¨¡å¼åˆ‡æ¢æ—¶çš„åŠ¨ç”»æ•ˆæœ`, 
                'info'
            );
        }

        function generateMockData() {
            // ç”ŸæˆåŒ…å«Colorå·¥ä½œè¡¨çš„æ¨¡æ‹Ÿæ•°æ®
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºColorå·¥ä½œè¡¨æ•°æ®
            const colorData = [
                ['G1', 'G2', 'G3', 'P1', 'P2', 'P3', 'P4', 'P5'],
                ['FF0000', '00FF00', '0000FF', 'FFFF00', 'FF00FF', '00FFFF', 'C0C0C0', '808080']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(colorData);
            XLSX.utils.book_append_sheet(wb, ws, 'Color');
            
            mockSourceData = {
                workbook: wb,
                fileName: 'test_color_data.xlsx'
            };
            
            showResult('mockDataResult', 
                `âœ… æ¨¡æ‹Ÿæ•°æ®ç”ŸæˆæˆåŠŸ<br>
                å·¥ä½œè¡¨: Color<br>
                å­—æ®µ: G1, G2, G3, P1, P2, P3, P4, P5<br>
                æ•°æ®è¡Œ: 1è¡Œé¢œè‰²æ•°æ®<br>
                <div class="code-block">${JSON.stringify(colorData, null, 2)}</div>`, 
                'success'
            );
        }
    </script>
</body>
</html>
