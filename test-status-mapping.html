<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statuså·¥ä½œè¡¨æ¡ä»¶æ˜ å°„æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-case {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #555;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .log-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
    <!-- å¼•å…¥SheetJSåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Statuså·¥ä½œè¡¨æ¡ä»¶æ˜ å°„æœºåˆ¶æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2 class="test-title">ğŸ§ª æµ‹è¯•åœºæ™¯</h2>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯1: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=1</h4>
            <p>æºæ•°æ®åŒ…å«Statuså·¥ä½œè¡¨ï¼ŒColorå­—æ®µçŠ¶æ€ä¸º1ï¼ˆæœ‰æ•ˆï¼‰</p>
            <button onclick="testStatusColorValid()">è¿è¡Œæµ‹è¯•</button>
            <div id="test1-result" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯2: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=0</h4>
            <p>æºæ•°æ®åŒ…å«Statuså·¥ä½œè¡¨ï¼ŒColorå­—æ®µçŠ¶æ€ä¸º0ï¼ˆæ— æ•ˆï¼‰</p>
            <button onclick="testStatusColorInvalid()">è¿è¡Œæµ‹è¯•</button>
            <div id="test2-result" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯3: å®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨ï¼ˆJSONæ˜ å°„æ¨¡å¼ï¼‰</h4>
            <p>æºæ•°æ®åŒ…å«"å®Œæ•´é…è‰²è¡¨"å·¥ä½œè¡¨ï¼Œåº”ä½¿ç”¨JSONé—´æ¥æ˜ å°„æ¨¡å¼</p>
            <button onclick="testJSONMapping()">è¿è¡Œæµ‹è¯•</button>
            <div id="test3-result" class="test-result" style="display: none;"></div>
        </div>
        
        <div class="test-case">
            <h4>æµ‹è¯•åœºæ™¯4: æ— ç‰¹æ®Šå·¥ä½œè¡¨ï¼ˆé»˜è®¤JSONæ˜ å°„ï¼‰</h4>
            <p>æºæ•°æ®æ—¢ä¸åŒ…å«Statusä¹Ÿä¸åŒ…å«"å®Œæ•´é…è‰²è¡¨"å·¥ä½œè¡¨</p>
            <button onclick="testDefaultMapping()">è¿è¡Œæµ‹è¯•</button>
            <div id="test4-result" class="test-result" style="display: none;"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h2 class="test-title">ğŸ“‹ æµ‹è¯•æ—¥å¿—</h2>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="log-output" class="log-output"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ§åˆ¶å°æ—¥å¿—è¾“å‡ºåˆ°é¡µé¢
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;
        
        function logToPage(message, type = 'log') {
            const logOutput = document.getElementById('log-output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '[ERROR]' : type === 'warn' ? '[WARN]' : '[LOG]';
            logOutput.textContent += `${timestamp} ${prefix} ${message}\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToPage(args.join(' '), 'log');
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            logToPage(args.join(' '), 'warn');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToPage(args.join(' '), 'error');
        };
        
        function clearLog() {
            document.getElementById('log-output').textContent = '';
        }
        
        // åˆ›å»ºæµ‹è¯•ç”¨çš„Excelæ•°æ®
        function createTestWorkbook(sheetData) {
            const wb = XLSX.utils.book_new();
            
            Object.keys(sheetData).forEach(sheetName => {
                const ws = XLSX.utils.aoa_to_sheet(sheetData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            return wb;
        }
        
        // æ¨¡æ‹Ÿæºæ•°æ®å¯¹è±¡
        function createSourceData(workbook, fileName = 'test.xlsx') {
            return {
                workbook: workbook,
                fileName: fileName,
                fileSize: 1024,
                headers: ['æµ‹è¯•è¡¨å¤´'],
                data: [{ 'æµ‹è¯•': 'æ•°æ®' }],
                validation: {
                    hasColorCode: true,
                    hasColorValue: true,
                    hasRGB: false,
                    totalRows: 1
                }
            };
        }
        
        function showResult(elementId, message, isSuccess) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            element.textContent = message;
        }
    </script>
    
    <!-- å¼•å…¥ä¿®æ”¹åçš„themeManager.jsè¿›è¡Œæµ‹è¯• -->
    <script src="js/utils.js"></script>
    <script src="js/themeManager.js"></script>
    
    <script>
        // æµ‹è¯•å‡½æ•°å®ç°
        function testStatusColorValid() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯1: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=1 ===');
            
            try {
                // åˆ›å»ºåŒ…å«Statuså·¥ä½œè¡¨çš„æµ‹è¯•æ•°æ®ï¼ŒColorçŠ¶æ€ä¸º1
                const testData = {
                    'Status': [
                        ['Color', 'Light', 'FloodLight'],  // è¡¨å¤´
                        [1, 0, 1]                          // çŠ¶æ€è¡Œï¼šColor=1(æœ‰æ•ˆ)
                    ],
                    'Color': [
                        ['P1', 'P2', 'G1'],               // Colorå·¥ä½œè¡¨è¡¨å¤´
                        ['FF0000', '00FF00', '0000FF']    // é¢œè‰²æ•°æ®
                    ]
                };
                
                const workbook = createTestWorkbook(testData);
                const sourceData = createSourceData(workbook, 'status_color_valid.xlsx');
                
                // æµ‹è¯•æ˜ å°„æ¨¡å¼æ£€æµ‹
                if (typeof window.App !== 'undefined' && window.App.ThemeManager) {
                    // å¦‚æœThemeManagerå¯ç”¨ï¼Œè¿›è¡Œå®Œæ•´æµ‹è¯•
                    const detectedMode = window.App.ThemeManager.detectMappingMode(sourceData);
                    
                    if (detectedMode === 'direct') {
                        showResult('test1-result', 'âœ… æµ‹è¯•é€šè¿‡ï¼šæ­£ç¡®æ£€æµ‹åˆ°ç›´æ¥æ˜ å°„æ¨¡å¼', true);
                        console.log('âœ… æµ‹è¯•åœºæ™¯1é€šè¿‡ï¼šStatuså·¥ä½œè¡¨æ£€æµ‹æˆåŠŸï¼Œå¯ç”¨ç›´æ¥æ˜ å°„æ¨¡å¼');
                    } else {
                        showResult('test1-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šåº”è¯¥æ£€æµ‹åˆ°ç›´æ¥æ˜ å°„æ¨¡å¼ï¼Œå®é™…æ£€æµ‹åˆ°ï¼š' + detectedMode, false);
                        console.error('âŒ æµ‹è¯•åœºæ™¯1å¤±è´¥ï¼šæ˜ å°„æ¨¡å¼æ£€æµ‹é”™è¯¯');
                    }
                } else {
                    // å¦‚æœThemeManagerä¸å¯ç”¨ï¼Œè¿›è¡ŒåŸºç¡€æµ‹è¯•
                    console.log('ThemeManagerä¸å¯ç”¨ï¼Œè¿›è¡ŒåŸºç¡€å·¥ä½œè¡¨æ£€æµ‹æµ‹è¯•');
                    const hasStatus = workbook.SheetNames.includes('Status');
                    const hasColor = workbook.SheetNames.includes('Color');
                    
                    if (hasStatus && hasColor) {
                        showResult('test1-result', 'âœ… åŸºç¡€æµ‹è¯•é€šè¿‡ï¼šå·¥ä½œè¡¨ç»“æ„æ­£ç¡®', true);
                        console.log('âœ… åŸºç¡€æµ‹è¯•é€šè¿‡ï¼šStatuså’ŒColorå·¥ä½œè¡¨éƒ½å­˜åœ¨');
                    } else {
                        showResult('test1-result', 'âŒ åŸºç¡€æµ‹è¯•å¤±è´¥ï¼šå·¥ä½œè¡¨ç»“æ„é”™è¯¯', false);
                        console.error('âŒ åŸºç¡€æµ‹è¯•å¤±è´¥ï¼šå·¥ä½œè¡¨ç»“æ„ä¸æ­£ç¡®');
                    }
                }
                
            } catch (error) {
                showResult('test1-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯1å¼‚å¸¸:', error);
            }
        }
        
        function testStatusColorInvalid() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯2: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=0 ===');
            
            try {
                const testData = {
                    'Status': [
                        ['Color', 'Light', 'FloodLight'],
                        [0, 1, 0]  // Color=0(æ— æ•ˆ)
                    ],
                    'Color': [
                        ['P1', 'P2', 'G1'],
                        ['FF0000', '00FF00', '0000FF']
                    ]
                };
                
                const workbook = createTestWorkbook(testData);
                const sourceData = createSourceData(workbook, 'status_color_invalid.xlsx');
                
                const hasStatus = workbook.SheetNames.includes('Status');
                if (hasStatus) {
                    showResult('test2-result', 'âœ… æµ‹è¯•é€šè¿‡ï¼šStatuså·¥ä½œè¡¨å­˜åœ¨ï¼ŒColorçŠ¶æ€ä¸º0', true);
                    console.log('âœ… æµ‹è¯•åœºæ™¯2é€šè¿‡ï¼šStatuså·¥ä½œè¡¨æ£€æµ‹æˆåŠŸï¼ŒColorçŠ¶æ€ä¸ºæ— æ•ˆ');
                } else {
                    showResult('test2-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šStatuså·¥ä½œè¡¨ä¸å­˜åœ¨', false);
                    console.error('âŒ æµ‹è¯•åœºæ™¯2å¤±è´¥ï¼šStatuså·¥ä½œè¡¨åˆ›å»ºå¤±è´¥');
                }
                
            } catch (error) {
                showResult('test2-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯2å¼‚å¸¸:', error);
            }
        }
        
        function testJSONMapping() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯3: å®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨ï¼ˆJSONæ˜ å°„æ¨¡å¼ï¼‰===');
            
            try {
                const testData = {
                    'å®Œæ•´é…è‰²è¡¨': [
                        ['é¢œè‰²ä»£ç ', '16è¿›åˆ¶å€¼'],
                        ['P1', 'FF0000'],
                        ['P2', '00FF00']
                    ]
                };
                
                const workbook = createTestWorkbook(testData);
                const sourceData = createSourceData(workbook, 'json_mapping.xlsx');
                
                const hasCompleteColor = workbook.SheetNames.includes('å®Œæ•´é…è‰²è¡¨');
                if (hasCompleteColor) {
                    showResult('test3-result', 'âœ… æµ‹è¯•é€šè¿‡ï¼šå®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨å­˜åœ¨ï¼Œåº”ä½¿ç”¨JSONæ˜ å°„æ¨¡å¼', true);
                    console.log('âœ… æµ‹è¯•åœºæ™¯3é€šè¿‡ï¼šå®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨æ£€æµ‹æˆåŠŸ');
                } else {
                    showResult('test3-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šå®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨ä¸å­˜åœ¨', false);
                    console.error('âŒ æµ‹è¯•åœºæ™¯3å¤±è´¥ï¼šå®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨åˆ›å»ºå¤±è´¥');
                }
                
            } catch (error) {
                showResult('test3-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯3å¼‚å¸¸:', error);
            }
        }
        
        function testDefaultMapping() {
            console.log('=== å¼€å§‹æµ‹è¯•åœºæ™¯4: æ— ç‰¹æ®Šå·¥ä½œè¡¨ï¼ˆé»˜è®¤JSONæ˜ å°„ï¼‰===');
            
            try {
                const testData = {
                    'Sheet1': [
                        ['æ™®é€šæ•°æ®'],
                        ['æµ‹è¯•']
                    ]
                };
                
                const workbook = createTestWorkbook(testData);
                const sourceData = createSourceData(workbook, 'default_mapping.xlsx');
                
                const hasStatus = workbook.SheetNames.includes('Status');
                const hasCompleteColor = workbook.SheetNames.includes('å®Œæ•´é…è‰²è¡¨');
                
                if (!hasStatus && !hasCompleteColor) {
                    showResult('test4-result', 'âœ… æµ‹è¯•é€šè¿‡ï¼šæ— ç‰¹æ®Šå·¥ä½œè¡¨ï¼Œåº”ä½¿ç”¨é»˜è®¤JSONæ˜ å°„æ¨¡å¼', true);
                    console.log('âœ… æµ‹è¯•åœºæ™¯4é€šè¿‡ï¼šæ— ç‰¹æ®Šå·¥ä½œè¡¨ï¼Œé»˜è®¤JSONæ˜ å°„');
                } else {
                    showResult('test4-result', 'âŒ æµ‹è¯•å¤±è´¥ï¼šå­˜åœ¨ç‰¹æ®Šå·¥ä½œè¡¨', false);
                    console.error('âŒ æµ‹è¯•åœºæ™¯4å¤±è´¥ï¼šä¸åº”è¯¥å­˜åœ¨ç‰¹æ®Šå·¥ä½œè¡¨');
                }
                
            } catch (error) {
                showResult('test4-result', 'âŒ æµ‹è¯•å¼‚å¸¸ï¼š' + error.message, false);
                console.error('æµ‹è¯•åœºæ™¯4å¼‚å¸¸:', error);
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Statuså·¥ä½œè¡¨æ¡ä»¶æ˜ å°„æµ‹è¯•é¡µé¢å·²åŠ è½½');
            console.log('XLSXåº“ç‰ˆæœ¬:', typeof XLSX !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
            console.log('ThemeManageræ¨¡å—:', typeof window.App !== 'undefined' && window.App.ThemeManager ? 'å·²åŠ è½½' : 'æœªåŠ è½½');
        });
    </script>
</body>
</html>
