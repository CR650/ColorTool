<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statusæ˜ å°„æ¨¡å¼ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        .log { 
            background-color: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 10px; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px; 
            white-space: pre-wrap; 
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <h1>Statuså·¥ä½œè¡¨æ¡ä»¶æ˜ å°„æœºåˆ¶æµ‹è¯•</h1>
    
    <div>
        <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div id="results"></div>
    <div id="log" class="log"></div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
        }
        
        function showResult(message, isSuccess) {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            div.textContent = message;
            resultsDiv.appendChild(div);
        }

        // æ¨¡æ‹ŸdetectMappingModeå‡½æ•°ï¼ˆåŸºäºæˆ‘ä»¬çš„ä¿®æ”¹ï¼‰
        function detectMappingMode(sourceData) {
            log('=== å¼€å§‹æ£€æµ‹æ˜ å°„æ¨¡å¼ ===');

            if (!sourceData || !sourceData.workbook) {
                log('æºæ•°æ®æ— æ•ˆï¼Œä½¿ç”¨JSONæ˜ å°„æ¨¡å¼');
                return 'json';
            }

            const sheetNames = sourceData.workbook.SheetNames;
            log('æºæ•°æ®å·¥ä½œè¡¨åˆ—è¡¨: ' + sheetNames.join(', '));

            // ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«"å®Œæ•´é…è‰²è¡¨"å·¥ä½œè¡¨
            const hasCompleteColorSheet = sheetNames.includes('å®Œæ•´é…è‰²è¡¨');
            if (hasCompleteColorSheet) {
                log('âœ… æ‰¾åˆ°"å®Œæ•´é…è‰²è¡¨"å·¥ä½œè¡¨ï¼Œä½¿ç”¨JSONé—´æ¥æ˜ å°„æ¨¡å¼');
                return 'json';
            }

            // ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«"Status"å·¥ä½œè¡¨
            const hasStatusSheet = sheetNames.includes('Status');
            if (hasStatusSheet) {
                log('âœ… æ‰¾åˆ°"Status"å·¥ä½œè¡¨ï¼Œä½¿ç”¨ç›´æ¥æ˜ å°„æ¨¡å¼');

                try {
                    const statusSheet = sourceData.workbook.Sheets['Status'];
                    const statusData = XLSX.utils.sheet_to_json(statusSheet, {
                        header: 1,
                        defval: '',
                        raw: false
                    });

                    if (!statusData || statusData.length < 2) {
                        log('âš ï¸ Statuså·¥ä½œè¡¨æ•°æ®ä¸è¶³ï¼Œå›é€€åˆ°JSONæ˜ å°„æ¨¡å¼');
                        return 'json';
                    }

                    const headers = statusData[0];
                    log('Statuså·¥ä½œè¡¨è¡¨å¤´: ' + headers.join(', '));

                    if (headers && headers.length > 0) {
                        log(`âœ… æ£€æµ‹åˆ°ç›´æ¥æ˜ å°„æ¨¡å¼ï¼šStatuså·¥ä½œè¡¨åŒ…å«${headers.length}ä¸ªå­—æ®µ`);
                        return 'direct';
                    } else {
                        log('âš ï¸ Statuså·¥ä½œè¡¨è¡¨å¤´ä¸ºç©ºï¼Œå›é€€åˆ°JSONæ˜ å°„æ¨¡å¼');
                        return 'json';
                    }

                } catch (error) {
                    log('è¯»å–Statuså·¥ä½œè¡¨æ—¶å‡ºé”™: ' + error.message);
                    log('âš ï¸ Statuså·¥ä½œè¡¨è¯»å–å¤±è´¥ï¼Œå›é€€åˆ°JSONæ˜ å°„æ¨¡å¼');
                    return 'json';
                }
            }

            log('æœªæ‰¾åˆ°"å®Œæ•´é…è‰²è¡¨"æˆ–"Status"å·¥ä½œè¡¨ï¼Œä½¿ç”¨JSONæ˜ å°„æ¨¡å¼');
            return 'json';
        }

        // æ¨¡æ‹ŸparseStatusSheetå‡½æ•°
        function parseStatusSheet(sourceData) {
            log('=== å¼€å§‹è§£æStatuså·¥ä½œè¡¨ ===');

            if (!sourceData || !sourceData.workbook) {
                log('æºæ•°æ®æ— æ•ˆï¼Œæ— æ³•è§£æStatuså·¥ä½œè¡¨');
                return { colorStatus: 0, hasColorField: false, error: 'æºæ•°æ®æ— æ•ˆ' };
            }

            try {
                const statusSheet = sourceData.workbook.Sheets['Status'];
                if (!statusSheet) {
                    log('Statuså·¥ä½œè¡¨ä¸å­˜åœ¨');
                    return { colorStatus: 0, hasColorField: false, error: 'Statuså·¥ä½œè¡¨ä¸å­˜åœ¨' };
                }

                const statusData = XLSX.utils.sheet_to_json(statusSheet, {
                    header: 1,
                    defval: '',
                    raw: false
                });

                if (!statusData || statusData.length < 2) {
                    log('Statuså·¥ä½œè¡¨æ•°æ®ä¸è¶³');
                    return { colorStatus: 0, hasColorField: false, error: 'Statuså·¥ä½œè¡¨æ•°æ®ä¸è¶³' };
                }

                const headers = statusData[0];
                const statusRow = statusData[1];

                log('Statuså·¥ä½œè¡¨è¡¨å¤´: ' + headers.join(', '));
                log('Statuså·¥ä½œè¡¨çŠ¶æ€è¡Œ: ' + statusRow.join(', '));

                // æŸ¥æ‰¾Coloråˆ—çš„ç´¢å¼•
                const colorColumnIndex = headers.findIndex(header => {
                    if (!header) return false;
                    const headerStr = header.toString().trim().toUpperCase();
                    return headerStr === 'COLOR';
                });

                if (colorColumnIndex === -1) {
                    log('Statuså·¥ä½œè¡¨ä¸­æœªæ‰¾åˆ°Coloråˆ—');
                    return { colorStatus: 0, hasColorField: false, error: 'æœªæ‰¾åˆ°Coloråˆ—' };
                }

                const colorStatusValue = statusRow[colorColumnIndex];
                const colorStatus = parseInt(colorStatusValue) || 0;

                log(`Colorå­—æ®µçŠ¶æ€: ${colorStatus} (åŸå§‹å€¼: "${colorStatusValue}")`);

                const result = {
                    colorStatus: colorStatus,
                    hasColorField: true,
                    colorColumnIndex: colorColumnIndex,
                    headers: headers,
                    statusRow: statusRow,
                    isColorValid: colorStatus === 1
                };

                log('Statuså·¥ä½œè¡¨è§£æç»“æœ: ' + JSON.stringify(result, null, 2));
                return result;

            } catch (error) {
                log('è§£æStatuså·¥ä½œè¡¨æ—¶å‡ºé”™: ' + error.message);
                return { colorStatus: 0, hasColorField: false, error: error.message };
            }
        }

        // åˆ›å»ºæµ‹è¯•å·¥ä½œç°¿
        function createTestWorkbook(sheetData) {
            const wb = XLSX.utils.book_new();
            
            Object.keys(sheetData).forEach(sheetName => {
                const ws = XLSX.utils.aoa_to_sheet(sheetData[sheetName]);
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            
            return wb;
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        function runAllTests() {
            clearLog();
            log('ğŸ§ª å¼€å§‹Statuså·¥ä½œè¡¨æ¡ä»¶æ˜ å°„æœºåˆ¶éªŒè¯æµ‹è¯•');
            
            let passedTests = 0;
            let totalTests = 4;

            // æµ‹è¯•1: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=1
            log('\n=== æµ‹è¯•1: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=1 ===');
            try {
                const test1Data = {
                    'Status': [
                        ['Color', 'Light', 'FloodLight'],
                        [1, 0, 1]
                    ],
                    'Color': [
                        ['P1', 'P2', 'G1'],
                        ['FF0000', '00FF00', '0000FF']
                    ]
                };
                
                const workbook1 = createTestWorkbook(test1Data);
                const sourceData1 = { workbook: workbook1, fileName: 'test1.xlsx' };
                
                const mode1 = detectMappingMode(sourceData1);
                const status1 = parseStatusSheet(sourceData1);
                
                if (mode1 === 'direct' && status1.isColorValid) {
                    showResult('âœ… æµ‹è¯•1é€šè¿‡: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=1', true);
                    passedTests++;
                } else {
                    showResult('âŒ æµ‹è¯•1å¤±è´¥: æœŸæœ›directæ¨¡å¼ä¸”Coloræœ‰æ•ˆ', false);
                }
            } catch (error) {
                showResult('âŒ æµ‹è¯•1å¼‚å¸¸: ' + error.message, false);
                log('æµ‹è¯•1å¼‚å¸¸: ' + error.message);
            }

            // æµ‹è¯•2: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=0
            log('\n=== æµ‹è¯•2: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=0 ===');
            try {
                const test2Data = {
                    'Status': [
                        ['Color', 'Light', 'FloodLight'],
                        [0, 1, 0]
                    ],
                    'Color': [
                        ['P1', 'P2', 'G1'],
                        ['FF0000', '00FF00', '0000FF']
                    ]
                };
                
                const workbook2 = createTestWorkbook(test2Data);
                const sourceData2 = { workbook: workbook2, fileName: 'test2.xlsx' };
                
                const mode2 = detectMappingMode(sourceData2);
                const status2 = parseStatusSheet(sourceData2);
                
                if (mode2 === 'direct' && !status2.isColorValid) {
                    showResult('âœ… æµ‹è¯•2é€šè¿‡: Statuså·¥ä½œè¡¨ + ColorçŠ¶æ€=0', true);
                    passedTests++;
                } else {
                    showResult('âŒ æµ‹è¯•2å¤±è´¥: æœŸæœ›directæ¨¡å¼ä¸”Coloræ— æ•ˆ', false);
                }
            } catch (error) {
                showResult('âŒ æµ‹è¯•2å¼‚å¸¸: ' + error.message, false);
                log('æµ‹è¯•2å¼‚å¸¸: ' + error.message);
            }

            // æµ‹è¯•3: å®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨
            log('\n=== æµ‹è¯•3: å®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨ï¼ˆJSONæ˜ å°„æ¨¡å¼ï¼‰===');
            try {
                const test3Data = {
                    'å®Œæ•´é…è‰²è¡¨': [
                        ['é¢œè‰²ä»£ç ', '16è¿›åˆ¶å€¼'],
                        ['P1', 'FF0000'],
                        ['P2', '00FF00']
                    ]
                };
                
                const workbook3 = createTestWorkbook(test3Data);
                const sourceData3 = { workbook: workbook3, fileName: 'test3.xlsx' };
                
                const mode3 = detectMappingMode(sourceData3);
                
                if (mode3 === 'json') {
                    showResult('âœ… æµ‹è¯•3é€šè¿‡: å®Œæ•´é…è‰²è¡¨å·¥ä½œè¡¨ä½¿ç”¨JSONæ˜ å°„', true);
                    passedTests++;
                } else {
                    showResult('âŒ æµ‹è¯•3å¤±è´¥: æœŸæœ›jsonæ¨¡å¼', false);
                }
            } catch (error) {
                showResult('âŒ æµ‹è¯•3å¼‚å¸¸: ' + error.message, false);
                log('æµ‹è¯•3å¼‚å¸¸: ' + error.message);
            }

            // æµ‹è¯•4: æ— ç‰¹æ®Šå·¥ä½œè¡¨
            log('\n=== æµ‹è¯•4: æ— ç‰¹æ®Šå·¥ä½œè¡¨ï¼ˆé»˜è®¤JSONæ˜ å°„ï¼‰===');
            try {
                const test4Data = {
                    'Sheet1': [
                        ['æ™®é€šæ•°æ®'],
                        ['æµ‹è¯•']
                    ]
                };
                
                const workbook4 = createTestWorkbook(test4Data);
                const sourceData4 = { workbook: workbook4, fileName: 'test4.xlsx' };
                
                const mode4 = detectMappingMode(sourceData4);
                
                if (mode4 === 'json') {
                    showResult('âœ… æµ‹è¯•4é€šè¿‡: æ— ç‰¹æ®Šå·¥ä½œè¡¨ä½¿ç”¨é»˜è®¤JSONæ˜ å°„', true);
                    passedTests++;
                } else {
                    showResult('âŒ æµ‹è¯•4å¤±è´¥: æœŸæœ›jsonæ¨¡å¼', false);
                }
            } catch (error) {
                showResult('âŒ æµ‹è¯•4å¼‚å¸¸: ' + error.message, false);
                log('æµ‹è¯•4å¼‚å¸¸: ' + error.message);
            }

            // æ€»ç»“
            log(`\nğŸ¯ æµ‹è¯•å®Œæˆ! é€šè¿‡: ${passedTests}/${totalTests}`);
            if (passedTests === totalTests) {
                showResult(`ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡! (${passedTests}/${totalTests})`, true);
            } else {
                showResult(`âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ (${passedTests}/${totalTests})`, false);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ˜¾ç¤ºçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            log('Statuså·¥ä½œè¡¨æ¡ä»¶æ˜ å°„æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('XLSXåº“: ' + (typeof XLSX !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½'));
        });
    </script>
</body>
</html>
