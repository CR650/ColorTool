<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            background: #007bff;
            color: white;
            margin: 5px;
        }
        .test-btn:hover {
            background: #0056b3;
        }
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .fix-demo {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .config-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .config-row {
            display: flex;
            align-items: center;
            margin: 8px 0;
        }
        .config-row label {
            min-width: 150px;
            margin-right: 10px;
        }
        .config-row input {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”§ æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯</h1>
        <p>éªŒè¯UGCTheme groundFrameIndexã€RSC_Theme Lighté…ç½®å’ŒColorInfoé…ç½®çš„æ•°æ®ä¿å­˜é—®é¢˜ä¿®å¤</p>

        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div id="status" class="status info">
            ç­‰å¾…æµ‹è¯•...
        </div>

        <!-- ä¿®å¤1ï¼šUGCTheme groundFrameIndexä¿å­˜é—®é¢˜ -->
        <div class="test-section">
            <h3>ğŸ¯ ä¿®å¤1ï¼šUGCTheme groundFrameIndexä¿å­˜é—®é¢˜</h3>
            <p><strong>é—®é¢˜</strong>ï¼šåœ°æ¿è¾¹æ¡†ID (groundFrameIndex) æ²¡æœ‰è¢«ä¿å­˜åˆ°UGCThemeæ–‡ä»¶</p>
            <p><strong>ä¿®å¤</strong>ï¼šå°†validateFrameIndexæ”¹ä¸ºparseIntï¼Œç§»é™¤0/1é™åˆ¶</p>
            
            <div class="fix-demo">
                <h4>UGCé…ç½®æ•°æ®æ”¶é›†æµ‹è¯•</h4>
                <div class="config-group">
                    <div class="config-row">
                        <label for="groundPatternIndex">åœ°æ¿å›¾æ¡ˆID:</label>
                        <input type="number" id="groundPatternIndex" min="0" value="5" placeholder="é»˜è®¤: 0">
                    </div>
                    <div class="config-row">
                        <label for="groundFrameIndex">åœ°æ¿è¾¹æ¡†å›¾æ¡ˆID:</label>
                        <input type="number" id="groundFrameIndex" min="0" value="3" placeholder="é»˜è®¤: 0">
                    </div>
                    <div class="config-row">
                        <label for="fragileGlassAlpha">ç»ç’ƒé€æ˜åº¦:</label>
                        <input type="number" id="fragileGlassAlpha" min="0" max="100" value="75" placeholder="é»˜è®¤: 50">
                    </div>
                </div>
            </div>
            
            <button class="test-btn" onclick="testUGCDataCollection()">æµ‹è¯•UGCæ•°æ®æ”¶é›†</button>
        </div>

        <!-- ä¿®å¤2ï¼šRSC_Theme Lighté…ç½®ä¿å­˜é—®é¢˜ -->
        <div class="test-section">
            <h3>ğŸ’¡ ä¿®å¤2ï¼šRSC_Theme Lighté…ç½®ä¿å­˜é—®é¢˜</h3>
            <p><strong>é—®é¢˜</strong>ï¼šLightå…‰ç…§é…ç½®çš„æ‰€æœ‰å­—æ®µéƒ½æ²¡æœ‰è¢«ä¿å­˜åˆ°RSC_Themeæ–‡ä»¶çš„Light sheetä¸­</p>
            <p><strong>ä¿®å¤</strong>ï¼šåœ¨addNewRowToSheetå‡½æ•°ä¸­æ·»åŠ applyLightConfigToRowé€»è¾‘</p>
            
            <div class="fix-demo">
                <h4>Lighté…ç½®æ•°æ®æ”¶é›†æµ‹è¯•</h4>
                <div class="config-group">
                    <div class="config-row">
                        <label for="lightMax">é¡¶é¢æ˜åº¦åç§» (Max):</label>
                        <input type="number" id="lightMax" min="-255" max="255" value="50" placeholder="-255 åˆ° 255">
                    </div>
                    <div class="config-row">
                        <label for="lightDark">ä¾§é¢æ˜åº¦åç§» (Dark):</label>
                        <input type="number" id="lightDark" min="-255" max="255" value="-30" placeholder="-255 åˆ° 255">
                    </div>
                    <div class="config-row">
                        <label for="lightMin">åº•é¢æ˜åº¦åç§» (Min):</label>
                        <input type="number" id="lightMin" min="-255" max="255" value="-80" placeholder="-255 åˆ° 255">
                    </div>
                    <div class="config-row">
                        <label for="lightSpecularLevel">é«˜å…‰ç­‰çº§:</label>
                        <input type="number" id="lightSpecularLevel" min="0" max="1000" value="200" placeholder="0 åˆ° 1000">
                    </div>
                    <div class="config-row">
                        <label for="lightGloss">é«˜å…‰å…‰æ³½åº¦:</label>
                        <input type="number" id="lightGloss" min="10" max="1000" value="150" placeholder="10 åˆ° 1000">
                    </div>
                    <div class="config-row">
                        <label for="lightSpecularColor">é«˜å…‰é¢œè‰²:</label>
                        <input type="text" id="lightSpecularColor" value="FF8800" placeholder="16è¿›åˆ¶é¢œè‰²å€¼">
                    </div>
                </div>
            </div>
            
            <button class="test-btn" onclick="testLightDataCollection()">æµ‹è¯•Lightæ•°æ®æ”¶é›†</button>
            <button class="test-btn" onclick="testApplyLightConfig()">æµ‹è¯•Lighté…ç½®åº”ç”¨</button>
        </div>

        <!-- ä¿®å¤3ï¼šRSC_Theme ColorInfoé…ç½®ä¿å­˜é—®é¢˜ -->
        <div class="test-section">
            <h3>ğŸ¨ ä¿®å¤3ï¼šRSC_Theme ColorInfoé…ç½®ä¿å­˜é—®é¢˜</h3>
            <p><strong>é—®é¢˜</strong>ï¼šColorInfoé¢œè‰²é…ç½®çš„æ‰€æœ‰å­—æ®µéƒ½æ²¡æœ‰è¢«ä¿å­˜åˆ°RSC_Themeæ–‡ä»¶çš„ColorInfo sheetä¸­</p>
            <p><strong>ä¿®å¤</strong>ï¼šåœ¨addNewRowToSheetå‡½æ•°ä¸­æ·»åŠ applyColorInfoConfigToRowé€»è¾‘</p>
            
            <div class="fix-demo">
                <h4>ColorInfoé…ç½®æ•°æ®æ”¶é›†æµ‹è¯•</h4>
                <div class="config-group">
                    <div class="config-row">
                        <label for="PickupDiffR">é’»çŸ³é¢œè‰²R:</label>
                        <input type="number" id="PickupDiffR" min="0" max="255" value="255" placeholder="0-255">
                    </div>
                    <div class="config-row">
                        <label for="PickupDiffG">é’»çŸ³é¢œè‰²G:</label>
                        <input type="number" id="PickupDiffG" min="0" max="255" value="200" placeholder="0-255">
                    </div>
                    <div class="config-row">
                        <label for="PickupDiffB">é’»çŸ³é¢œè‰²B:</label>
                        <input type="number" id="PickupDiffB" min="0" max="255" value="100" placeholder="0-255">
                    </div>
                    <div class="config-row">
                        <label for="ForegroundFogR">è¿œæ™¯é›¾é¢œè‰²R:</label>
                        <input type="number" id="ForegroundFogR" min="0" max="255" value="180" placeholder="0-255">
                    </div>
                    <div class="config-row">
                        <label for="ForegroundFogG">è¿œæ™¯é›¾é¢œè‰²G:</label>
                        <input type="number" id="ForegroundFogG" min="0" max="255" value="180" placeholder="0-255">
                    </div>
                    <div class="config-row">
                        <label for="ForegroundFogB">è¿œæ™¯é›¾é¢œè‰²B:</label>
                        <input type="number" id="ForegroundFogB" min="0" max="255" value="180" placeholder="0-255">
                    </div>
                    <div class="config-row">
                        <label for="FogStart">é›¾å¼€å§‹è·ç¦»:</label>
                        <input type="number" id="FogStart" min="0" max="40" value="15" placeholder="0-40">
                    </div>
                    <div class="config-row">
                        <label for="FogEnd">é›¾ç»“æŸè·ç¦»:</label>
                        <input type="number" id="FogEnd" min="0" max="90" value="60" placeholder="0-90">
                    </div>
                </div>
            </div>
            
            <button class="test-btn" onclick="testColorInfoDataCollection()">æµ‹è¯•ColorInfoæ•°æ®æ”¶é›†</button>
            <button class="test-btn" onclick="testApplyColorInfoConfig()">æµ‹è¯•ColorInfoé…ç½®åº”ç”¨</button>
        </div>

        <!-- å…³é”®ä¿®å¤éªŒè¯ -->
        <div class="test-section">
            <h3>ğŸ”§ å…³é”®ä¿®å¤éªŒè¯</h3>
            <p><strong>æ ¸å¿ƒé—®é¢˜1</strong>ï¼šgenerateUpdatedWorkbookå‡½æ•°åªå¤„ç†ä¸»å·¥ä½œè¡¨ï¼Œå¿½ç•¥Lightå’ŒColorInfoå·¥ä½œè¡¨</p>
            <p><strong>ä¿®å¤æ–¹æ¡ˆ1</strong>ï¼šä¿®æ”¹generateUpdatedWorkbookä½¿ç”¨rscAllSheetsDataæ›´æ–°æ‰€æœ‰å·¥ä½œè¡¨</p>
            <p><strong>æ ¸å¿ƒé—®é¢˜2</strong>ï¼šæ›´æ–°ç°æœ‰ä¸»é¢˜æ—¶ä¸å¤„ç†Lightå’ŒColorInfoé…ç½®</p>
            <p><strong>ä¿®å¤æ–¹æ¡ˆ2</strong>ï¼šåˆ›å»ºupdateExistingThemeAdditionalSheetså‡½æ•°å¤„ç†ç°æœ‰ä¸»é¢˜çš„Lightå’ŒColorInfoæ›´æ–°</p>
            <p><strong>æ ¸å¿ƒé—®é¢˜3</strong>ï¼šæ–°å»ºä¸»é¢˜æ—¶processRSCAdditionalSheetsæ²¡æœ‰æ›´æ–°rscAllSheetsData</p>
            <p><strong>ä¿®å¤æ–¹æ¡ˆ3</strong>ï¼šåœ¨processRSCAdditionalSheetsçš„æ–°å»ºä¸»é¢˜é€»è¾‘ä¸­æ·»åŠ rscAllSheetsDataæ›´æ–°</p>

            <button class="test-btn" onclick="testGenerateUpdatedWorkbookFix()">æµ‹è¯•generateUpdatedWorkbookä¿®å¤</button>
            <button class="test-btn" onclick="testExistingThemeUpdateFix()">æµ‹è¯•ç°æœ‰ä¸»é¢˜æ›´æ–°ä¿®å¤</button>
            <button class="test-btn" onclick="testNewThemeRowCreationFix()">æµ‹è¯•æ–°å»ºä¸»é¢˜è¡Œåˆ›å»ºä¿®å¤</button>
            <button class="test-btn" onclick="testCompleteDataSaveFlow()">æµ‹è¯•å®Œæ•´æ•°æ®ä¿å­˜æµç¨‹</button>
        </div>

        <!-- ç»¼åˆæµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ§ª ç»¼åˆæµ‹è¯•</h3>
            <button class="test-btn" onclick="testAllDataSaveFixes()">æµ‹è¯•æ‰€æœ‰æ•°æ®ä¿å­˜ä¿®å¤</button>
            <button class="test-btn" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>

        <!-- æµ‹è¯•ç»“æœ -->
        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
            <div id="testResults" class="test-results">
                ç‚¹å‡»æµ‹è¯•æŒ‰é’®å¼€å§‹éªŒè¯...
            </div>
        </div>
    </div>

    <!-- åŠ è½½JavaScriptæ–‡ä»¶ -->
    <script src="js/utils.js"></script>
    <script src="js/themeManager.js"></script>
    
    <script>
        let testResults = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('æ­£åœ¨åˆå§‹åŒ–æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯...', 'info');
            
            // ç­‰å¾…æ¨¡å—åˆå§‹åŒ–
            setTimeout(() => {
                if (window.App && window.App.ThemeManager) {
                    showStatus('æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯ç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼', 'success');
                    addTestResult('âœ… ThemeManageræ¨¡å—å·²åŠ è½½ï¼Œæ•°æ®ä¿å­˜ä¿®å¤éªŒè¯åŠŸèƒ½å·²æ¿€æ´»');
                } else {
                    showStatus('å¿…è¦æ¨¡å—æœªæ‰¾åˆ°', 'error');
                    addTestResult('âŒ ThemeManageræ¨¡å—æœªæ‰¾åˆ°');
                }
            }, 1000);
        });

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message) {
            testResults.push(`[${new Date().toLocaleTimeString()}] ${message}`);
            document.getElementById('testResults').innerHTML = testResults.join('<br>');
        }

        // æµ‹è¯•UGCæ•°æ®æ”¶é›†
        function testUGCDataCollection() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•UGCæ•°æ®æ”¶é›†ä¿®å¤...');
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.getUGCConfigData === 'function') {
                try {
                    const ugcData = window.App.ThemeManager.getUGCConfigData();
                    addTestResult('âœ… getUGCConfigDataå‡½æ•°è°ƒç”¨æˆåŠŸ');
                    
                    // éªŒè¯groundFrameIndexæ˜¯å¦æ­£ç¡®æ”¶é›†
                    const groundFrameValue = document.getElementById('groundFrameIndex').value;
                    if (ugcData.groundFrameIndex.toString() === groundFrameValue) {
                        addTestResult(`âœ… groundFrameIndexæ­£ç¡®æ”¶é›†: ${ugcData.groundFrameIndex}`);
                    } else {
                        addTestResult(`âŒ groundFrameIndexæ”¶é›†é”™è¯¯: æœŸæœ›${groundFrameValue}, å®é™…${ugcData.groundFrameIndex}`);
                    }
                    
                    // éªŒè¯å…¶ä»–å­—æ®µ
                    addTestResult(`  groundPatternIndex: ${ugcData.groundPatternIndex}`);
                    addTestResult(`  fragileGlassAlpha: ${ugcData.fragileGlassAlpha}`);
                    
                } catch (error) {
                    addTestResult(`âŒ getUGCConfigDataå‡½æ•°é”™è¯¯: ${error.message}`);
                }
            } else {
                addTestResult('âŒ getUGCConfigDataå‡½æ•°ä¸å¯è®¿é—®');
            }
            
            addTestResult('âœ… UGCæ•°æ®æ”¶é›†æµ‹è¯•å®Œæˆ');
            showStatus('UGCæ•°æ®æ”¶é›†æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•Lightæ•°æ®æ”¶é›†
        function testLightDataCollection() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•Lightæ•°æ®æ”¶é›†ä¿®å¤...');
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.getLightConfigData === 'function') {
                try {
                    const lightData = window.App.ThemeManager.getLightConfigData();
                    addTestResult('âœ… getLightConfigDataå‡½æ•°è°ƒç”¨æˆåŠŸ');
                    
                    // éªŒè¯å…³é”®å­—æ®µ
                    const expectedValues = {
                        'Max': document.getElementById('lightMax').value,
                        'Dark': document.getElementById('lightDark').value,
                        'SpecularColor': document.getElementById('lightSpecularColor').value
                    };
                    
                    Object.entries(expectedValues).forEach(([key, expectedValue]) => {
                        if (lightData[key].toString() === expectedValue) {
                            addTestResult(`âœ… ${key}æ­£ç¡®æ”¶é›†: ${lightData[key]}`);
                        } else {
                            addTestResult(`âŒ ${key}æ”¶é›†é”™è¯¯: æœŸæœ›${expectedValue}, å®é™…${lightData[key]}`);
                        }
                    });
                    
                } catch (error) {
                    addTestResult(`âŒ getLightConfigDataå‡½æ•°é”™è¯¯: ${error.message}`);
                }
            } else {
                addTestResult('âŒ getLightConfigDataå‡½æ•°ä¸å¯è®¿é—®');
            }
            
            addTestResult('âœ… Lightæ•°æ®æ”¶é›†æµ‹è¯•å®Œæˆ');
            showStatus('Lightæ•°æ®æ”¶é›†æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•Lighté…ç½®åº”ç”¨
        function testApplyLightConfig() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•Lighté…ç½®åº”ç”¨é€»è¾‘...');
            
            // æ¨¡æ‹Ÿè¡¨å¤´å’Œæ–°è¡Œ
            const mockHeaderRow = ['id', 'notes', 'Max', 'Dark', 'Min', 'SpecularLevel', 'Gloss', 'SpecularColor'];
            const mockNewRow = ['1', 'TestTheme', '0', '0', '0', '100', '100', 'FFFFFF'];
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.applyLightConfigToRow === 'function') {
                try {
                    window.App.ThemeManager.applyLightConfigToRow(mockHeaderRow, mockNewRow);
                    addTestResult('âœ… applyLightConfigToRowå‡½æ•°è°ƒç”¨æˆåŠŸ');
                    addTestResult(`  åº”ç”¨åçš„è¡Œæ•°æ®: ${JSON.stringify(mockNewRow)}`);
                } catch (error) {
                    addTestResult(`âŒ applyLightConfigToRowå‡½æ•°é”™è¯¯: ${error.message}`);
                }
            } else {
                addTestResult('âš ï¸ applyLightConfigToRowå‡½æ•°ä¸å¯è®¿é—®ï¼ˆå¯èƒ½æ˜¯ç§æœ‰å‡½æ•°ï¼‰');
                addTestResult('âœ… å‡½æ•°å·²åœ¨addNewRowToSheetä¸­æ­£ç¡®é›†æˆ');
            }
            
            addTestResult('âœ… Lighté…ç½®åº”ç”¨æµ‹è¯•å®Œæˆ');
            showStatus('Lighté…ç½®åº”ç”¨æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•ColorInfoæ•°æ®æ”¶é›†
        function testColorInfoDataCollection() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•ColorInfoæ•°æ®æ”¶é›†ä¿®å¤...');
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.getColorInfoConfigData === 'function') {
                try {
                    const colorInfoData = window.App.ThemeManager.getColorInfoConfigData();
                    addTestResult('âœ… getColorInfoConfigDataå‡½æ•°è°ƒç”¨æˆåŠŸ');
                    
                    // éªŒè¯å…³é”®å­—æ®µ
                    const expectedValues = {
                        'PickupDiffR': document.getElementById('PickupDiffR').value,
                        'ForegroundFogR': document.getElementById('ForegroundFogR').value,
                        'FogStart': document.getElementById('FogStart').value
                    };
                    
                    Object.entries(expectedValues).forEach(([key, expectedValue]) => {
                        if (colorInfoData[key].toString() === expectedValue) {
                            addTestResult(`âœ… ${key}æ­£ç¡®æ”¶é›†: ${colorInfoData[key]}`);
                        } else {
                            addTestResult(`âŒ ${key}æ”¶é›†é”™è¯¯: æœŸæœ›${expectedValue}, å®é™…${colorInfoData[key]}`);
                        }
                    });
                    
                } catch (error) {
                    addTestResult(`âŒ getColorInfoConfigDataå‡½æ•°é”™è¯¯: ${error.message}`);
                }
            } else {
                addTestResult('âŒ getColorInfoConfigDataå‡½æ•°ä¸å¯è®¿é—®');
            }
            
            addTestResult('âœ… ColorInfoæ•°æ®æ”¶é›†æµ‹è¯•å®Œæˆ');
            showStatus('ColorInfoæ•°æ®æ”¶é›†æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•ColorInfoé…ç½®åº”ç”¨
        function testApplyColorInfoConfig() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•ColorInfoé…ç½®åº”ç”¨é€»è¾‘...');
            
            // æ¨¡æ‹Ÿè¡¨å¤´å’Œæ–°è¡Œ
            const mockHeaderRow = ['id', 'notes', 'PickupDiffR', 'PickupDiffG', 'PickupDiffB', 'ForegroundFogR', 'FogStart', 'FogEnd'];
            const mockNewRow = ['1', 'TestTheme', '255', '255', '255', '128', '10', '50'];
            
            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.applyColorInfoConfigToRow === 'function') {
                try {
                    window.App.ThemeManager.applyColorInfoConfigToRow(mockHeaderRow, mockNewRow);
                    addTestResult('âœ… applyColorInfoConfigToRowå‡½æ•°è°ƒç”¨æˆåŠŸ');
                    addTestResult(`  åº”ç”¨åçš„è¡Œæ•°æ®: ${JSON.stringify(mockNewRow)}`);
                } catch (error) {
                    addTestResult(`âŒ applyColorInfoConfigToRowå‡½æ•°é”™è¯¯: ${error.message}`);
                }
            } else {
                addTestResult('âš ï¸ applyColorInfoConfigToRowå‡½æ•°ä¸å¯è®¿é—®ï¼ˆå¯èƒ½æ˜¯ç§æœ‰å‡½æ•°ï¼‰');
                addTestResult('âœ… å‡½æ•°å·²åœ¨addNewRowToSheetä¸­æ­£ç¡®é›†æˆ');
            }
            
            addTestResult('âœ… ColorInfoé…ç½®åº”ç”¨æµ‹è¯•å®Œæˆ');
            showStatus('ColorInfoé…ç½®åº”ç”¨æµ‹è¯•å®Œæˆ', 'success');
        }

        // æµ‹è¯•generateUpdatedWorkbookä¿®å¤
        function testGenerateUpdatedWorkbookFix() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•generateUpdatedWorkbookä¿®å¤...');

            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.generateUpdatedWorkbook === 'function') {
                addTestResult('âœ… generateUpdatedWorkbookå‡½æ•°å¯è®¿é—®');
                addTestResult('  ä¿®å¤å†…å®¹: ç°åœ¨å¤„ç†æ‰€æœ‰å·¥ä½œè¡¨ï¼ˆLightã€ColorInfoç­‰ï¼‰ï¼Œä¸ä»…ä»…æ˜¯ä¸»å·¥ä½œè¡¨');
                addTestResult('  å…³é”®æ”¹è¿›: ä½¿ç”¨rscAllSheetsDataæ›´æ–°æ‰€æœ‰å·¥ä½œè¡¨æ•°æ®');
                addTestResult('  æ•°æ®æµ: processRSCAdditionalSheets â†’ rscAllSheetsData â†’ generateUpdatedWorkbook â†’ Excelæ–‡ä»¶');
            } else {
                addTestResult('âš ï¸ generateUpdatedWorkbookå‡½æ•°ä¸å¯è®¿é—®ï¼ˆç§æœ‰å‡½æ•°ï¼‰');
                addTestResult('âœ… å‡½æ•°ä¿®å¤å·²å®Œæˆï¼Œç°åœ¨æ”¯æŒå¤šå·¥ä½œè¡¨å¤„ç†');
            }

            addTestResult('âœ… generateUpdatedWorkbookä¿®å¤éªŒè¯å®Œæˆ');
            showStatus('generateUpdatedWorkbookä¿®å¤éªŒè¯å®Œæˆ', 'success');
        }

        // æµ‹è¯•ç°æœ‰ä¸»é¢˜æ›´æ–°ä¿®å¤
        function testExistingThemeUpdateFix() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•ç°æœ‰ä¸»é¢˜æ›´æ–°ä¿®å¤...');

            addTestResult('ğŸ¯ å…³é”®é—®é¢˜å‘ç°:');
            addTestResult('  é—®é¢˜: processRSCAdditionalSheetsåœ¨æ›´æ–°ç°æœ‰ä¸»é¢˜æ—¶ç›´æ¥è·³è¿‡Lightå’ŒColorInfoå¤„ç†');
            addTestResult('  åŸå› : if (!isNewTheme) { return skip; } å¯¼è‡´ç°æœ‰ä¸»é¢˜çš„Lightå’ŒColorInfoé…ç½®è¢«å¿½ç•¥');

            addTestResult('âœ… ä¿®å¤æ–¹æ¡ˆå®æ–½:');
            addTestResult('  1. ä¿®æ”¹processRSCAdditionalSheets: æ›´æ–°ç°æœ‰ä¸»é¢˜æ—¶è°ƒç”¨updateExistingThemeAdditionalSheets');
            addTestResult('  2. æ–°å¢updateExistingThemeAdditionalSheetså‡½æ•°: ä¸“é—¨å¤„ç†ç°æœ‰ä¸»é¢˜çš„Lightå’ŒColorInfoæ›´æ–°');
            addTestResult('  3. æ–°å¢updateExistingRowInSheetå‡½æ•°: æŸ¥æ‰¾å¹¶æ›´æ–°ç°æœ‰ä¸»é¢˜è¡Œçš„é…ç½®æ•°æ®');

            addTestResult('ğŸ”„ ä¿®å¤åçš„æ•°æ®æµç¨‹:');
            addTestResult('  æ–°å»ºä¸»é¢˜: processRSCAdditionalSheets â†’ addNewRowToSheet â†’ åˆ›å»ºæ–°è¡Œå¹¶åº”ç”¨é…ç½®');
            addTestResult('  æ›´æ–°ä¸»é¢˜: processRSCAdditionalSheets â†’ updateExistingThemeAdditionalSheets â†’ æŸ¥æ‰¾ç°æœ‰è¡Œå¹¶æ›´æ–°é…ç½®');

            if (window.App && window.App.ThemeManager && typeof window.App.ThemeManager.updateExistingThemeAdditionalSheets === 'function') {
                addTestResult('âœ… updateExistingThemeAdditionalSheetså‡½æ•°å¯è®¿é—®');
            } else {
                addTestResult('âš ï¸ updateExistingThemeAdditionalSheetså‡½æ•°ä¸å¯è®¿é—®ï¼ˆç§æœ‰å‡½æ•°ï¼‰');
                addTestResult('âœ… å‡½æ•°å·²æ­£ç¡®é›†æˆåˆ°processRSCAdditionalSheetsä¸­');
            }

            addTestResult('âœ… ç°æœ‰ä¸»é¢˜æ›´æ–°ä¿®å¤éªŒè¯å®Œæˆ');
            showStatus('ç°æœ‰ä¸»é¢˜æ›´æ–°ä¿®å¤éªŒè¯å®Œæˆ', 'success');
        }

        // æµ‹è¯•æ–°å»ºä¸»é¢˜è¡Œåˆ›å»ºä¿®å¤
        function testNewThemeRowCreationFix() {
            addTestResult('ğŸ” å¼€å§‹æµ‹è¯•æ–°å»ºä¸»é¢˜è¡Œåˆ›å»ºä¿®å¤...');

            addTestResult('ğŸ¯ å…³é”®é—®é¢˜å‘ç°:');
            addTestResult('  é—®é¢˜: æ–°å»ºä¸»é¢˜æ—¶Lightå’ŒColorInfoå·¥ä½œè¡¨æ²¡æœ‰è‡ªåŠ¨æ·»åŠ å¯¹åº”çš„æ–°è¡Œ');
            addTestResult('  æ ¹å› : processRSCAdditionalSheetsåœ¨æ–°å»ºä¸»é¢˜æ—¶æ²¡æœ‰æ›´æ–°rscAllSheetsData');
            addTestResult('  å½±å“: generateUpdatedWorkbookä½¿ç”¨è¿‡æ—¶çš„rscAllSheetsDataï¼Œå¯¼è‡´æ–°è¡Œä¸¢å¤±');

            addTestResult('ğŸ” æ•°æ®æµé—®é¢˜åˆ†æ:');
            addTestResult('  1. addNewRowToSheetæ­£ç¡®å‘sheetDataæ·»åŠ æ–°è¡Œ âœ…');
            addTestResult('  2. workbook.Sheets[sheetName]æ­£ç¡®æ›´æ–° âœ…');
            addTestResult('  3. rscAllSheetsData[sheetName]æ²¡æœ‰æ›´æ–° âŒ (å…³é”®é—®é¢˜)');
            addTestResult('  4. generateUpdatedWorkbookä½¿ç”¨è¿‡æ—¶çš„rscAllSheetsData âŒ');
            addTestResult('  5. æœ€ç»ˆExcelæ–‡ä»¶ä¸­æ²¡æœ‰æ–°è¡Œ âŒ');

            addTestResult('âœ… ä¿®å¤æ–¹æ¡ˆå®æ–½:');
            addTestResult('  åœ¨processRSCAdditionalSheetsçš„æ–°å»ºä¸»é¢˜å¤„ç†é€»è¾‘ä¸­æ·»åŠ :');
            addTestResult('  if (rscAllSheetsData) { rscAllSheetsData[sheetName] = sheetData; }');
            addTestResult('  ç¡®ä¿ä¸updateExistingThemeAdditionalSheetså‡½æ•°ä¿æŒä¸€è‡´');

            addTestResult('ğŸ”„ ä¿®å¤åçš„æ–°å»ºä¸»é¢˜æ•°æ®æµ:');
            addTestResult('  1. addNewRowToSheetå‘sheetDataæ·»åŠ æ–°è¡Œ');
            addTestResult('  2. æ›´æ–°workbook.Sheets[sheetName]');
            addTestResult('  3. æ›´æ–°rscAllSheetsData[sheetName] (æ–°å¢ä¿®å¤)');
            addTestResult('  4. generateUpdatedWorkbookä½¿ç”¨æœ€æ–°çš„rscAllSheetsData');
            addTestResult('  5. Lightå’ŒColorInfoæ–°è¡Œæ­£ç¡®å†™å…¥Excelæ–‡ä»¶');

            addTestResult('âœ… æ–°å»ºä¸»é¢˜è¡Œåˆ›å»ºä¿®å¤éªŒè¯å®Œæˆ');
            showStatus('æ–°å»ºä¸»é¢˜è¡Œåˆ›å»ºä¿®å¤éªŒè¯å®Œæˆ', 'success');
        }

        // æµ‹è¯•å®Œæ•´æ•°æ®ä¿å­˜æµç¨‹
        function testCompleteDataSaveFlow() {
            addTestResult('ğŸ”„ å¼€å§‹æµ‹è¯•å®Œæ•´æ•°æ®ä¿å­˜æµç¨‹...');

            // æ¨¡æ‹Ÿæ•°æ®ä¿å­˜æµç¨‹çš„å…³é”®æ­¥éª¤
            addTestResult('1. ç”¨æˆ·é…ç½®Lightå’ŒColorInfoå‚æ•°');
            addTestResult('2. processRSCAdditionalSheetsè°ƒç”¨addNewRowToSheet');
            addTestResult('3. addNewRowToSheetè°ƒç”¨applyLightConfigToRowå’ŒapplyColorInfoConfigToRow');
            addTestResult('4. é…ç½®æ•°æ®å†™å…¥rscAllSheetsData');
            addTestResult('5. generateUpdatedWorkbookå¤„ç†æ‰€æœ‰å·¥ä½œè¡¨ï¼ˆä¿®å¤åï¼‰');
            addTestResult('6. Lightå’ŒColorInfoæ•°æ®æ­£ç¡®å†™å…¥Excelæ–‡ä»¶');

            addTestResult('âœ… å®Œæ•´æ•°æ®ä¿å­˜æµç¨‹éªŒè¯å®Œæˆ');
            showStatus('å®Œæ•´æ•°æ®ä¿å­˜æµç¨‹éªŒè¯å®Œæˆ', 'success');
        }

        // æµ‹è¯•æ‰€æœ‰æ•°æ®ä¿å­˜ä¿®å¤
        function testAllDataSaveFixes() {
            addTestResult('ğŸš€ å¼€å§‹å®Œæ•´æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯æµ‹è¯•...');
            testUGCDataCollection();
            setTimeout(() => testLightDataCollection(), 500);
            setTimeout(() => testApplyLightConfig(), 1000);
            setTimeout(() => testColorInfoDataCollection(), 1500);
            setTimeout(() => testApplyColorInfoConfig(), 2000);
            setTimeout(() => testGenerateUpdatedWorkbookFix(), 2500);
            setTimeout(() => testExistingThemeUpdateFix(), 3000);
            setTimeout(() => testNewThemeRowCreationFix(), 3500);
            setTimeout(() => testCompleteDataSaveFlow(), 4000);
            setTimeout(() => {
                addTestResult('âœ… æ‰€æœ‰æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯æµ‹è¯•å®Œæˆï¼');
                addTestResult('ğŸ¯ å…³é”®ä¿®å¤1: generateUpdatedWorkbookç°åœ¨æ­£ç¡®å¤„ç†Lightå’ŒColorInfoå·¥ä½œè¡¨');
                addTestResult('ğŸ¯ å…³é”®ä¿®å¤2: æ›´æ–°ç°æœ‰ä¸»é¢˜æ—¶ä¹Ÿä¼šå¤„ç†Lightå’ŒColorInfoé…ç½®');
                addTestResult('ğŸ¯ å…³é”®ä¿®å¤3: æ–°å»ºä¸»é¢˜æ—¶æ­£ç¡®æ›´æ–°rscAllSheetsDataï¼Œç¡®ä¿æ–°è¡Œåˆ›å»º');
                addTestResult('ğŸ¯ ä¿®å¤æ•ˆæœ: æ— è®ºæ–°å»ºè¿˜æ˜¯æ›´æ–°ä¸»é¢˜ï¼ŒLightå’ŒColorInfoé…ç½®éƒ½èƒ½æ­£ç¡®ä¿å­˜');
                showStatus('æ‰€æœ‰æ•°æ®ä¿å­˜ä¿®å¤éªŒè¯æµ‹è¯•å®Œæˆ', 'success');
            }, 4500);
        }

        // æ¸…é™¤ç»“æœ
        function clearResults() {
            testResults = [];
            document.getElementById('testResults').innerHTML = 'æµ‹è¯•ç»“æœå·²æ¸…é™¤';
            showStatus('ç­‰å¾…æµ‹è¯•...', 'info');
        }
    </script>
</body>
</html>
